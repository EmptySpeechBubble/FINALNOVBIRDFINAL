<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üê¶ Bird Window RPG</title>
    <style>
        /* Squarespace & iframe compatibility - force fullscreen, no borders */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: 100% !important;
            overflow-x: hidden !important;
        }

        /* Remove any potential iframe borders/margins */
        body.sqs-edit-mode-active,
        .sqs-block-content,
        .sqs-block-html {
            margin: 0 !important;
            padding: 0 !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #B0D8F0 100%);
            min-height: 100vh;
            color: #2d3436;
            overflow-x: hidden;
            position: relative;
            transition: background 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
        }

        /* Day/Night indicator in corner - positioned relative to widget */
        #day-night-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 32px;
            z-index: 100;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            animation: float 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Stars for night mode - positioned relative to widget */
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
            overflow: hidden;
        }

        .stars.active {
            opacity: 1;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }

        /* Game container - responsive and fullscreen compatible */
        #game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 4px;
            min-height: 100vh;
            width: 100%;
            max-height: 100vh;
            overflow-y: auto;
        }

        #main-content {
            width: 100%;
            overflow: visible;
        }

        /* Mobile: Tamagotchi/Handheld Gaming Device Style - Ultra Compact */
        @media (max-width: 599px) {
            /* Background will be set dynamically by JS based on day/night */
            body {
                transition: background 0.5s ease;
            }

            #game-container {
                padding: 0;
                max-height: 100vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* ULTRA COMPACT HEADER - Single line with just icons and numbers */
            #game-header {
                padding: 1px;
                margin: 0;
                flex-shrink: 0;
                border-radius: 0;
                background: rgba(250, 250, 250, 0.9);
                box-shadow: none;
                transition: background 0.5s ease, color 0.5s ease;
            }

            #game-title {
                font-size: 9px;
                margin: 0;
                padding: 2px;
                text-align: center;
                font-weight: bold;
            }

            /* Hide New Game / Help buttons on mobile */
            #game-header > div:first-of-type {
                display: none;
            }

            /* Single line info - readable */
            #season-info, #level-info {
                display: inline-block;
                font-size: 6px;
                margin: 0;
                padding: 0 3px;
                background: transparent;
                border-radius: 0;
            }

            #action-info {
                display: inline-block;
                font-size: 6px;
                margin: 0;
                padding: 0 3px;
            }

            /* Just numbers, no labels */
            .stat-compact-label,
            .inventory-item-label {
                display: none;
            }

            #stats-grid {
                display: none;
            }

            /* Single line stats - just emoji + number */
            #game-header > div:nth-child(3) {
                font-size: 7px;
                line-height: 1.2;
                margin: 0;
                padding: 2px;
            }

            .stat-compact {
                padding: 0 3px;
                font-size: 7px;
                background: transparent;
                border-radius: 0;
            }

            /* Inventory - minimal inline */
            #inventory {
                padding: 0 3px;
                margin: 0;
                font-size: 7px;
                background: transparent;
                border-radius: 0;
                text-align: center;
            }

            .inventory-title {
                display: none;
            }

            .inventory-item {
                font-size: 6px;
                margin: 0;
                padding: 0 2px;
                background: transparent;
            }

            /* Weather - inline, readable */
            #weather-display {
                padding: 1px 3px;
                margin: 0;
                font-size: 6px;
                background: transparent;
                border-radius: 0;
            }

            /* Message log - readable */
            #message-log {
                max-height: 16px;
                margin: 0 0 2px 0;
                padding: 2px;
                font-size: 6px;
                line-height: 1.2;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 2px;
                overflow-y: auto;
                transition: background 0.5s ease;
            }

            .message {
                margin: 0;
                padding: 1px;
                font-size: 6px;
                border-left-width: 1px;
                color: #fff;
                text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            }

            /* MAP - slightly smaller to make room for readable actions */
            #map-canvas {
                width: 220px;
                height: 220px;
                border-radius: 4px;
            }

            #map-wrapper {
                width: 220px;
                margin: 0 auto;
            }

            /* READABLE action buttons - bigger text, 3 columns */
            .action-btn {
                padding: 4px 2px;
                font-size: 7px;
                border-radius: 3px;
                gap: 1px;
            }

            .btn-emoji {
                font-size: 14px;
            }

            .btn-text {
                font-size: 7px;
                display: block; /* Show text! */
                font-weight: bold;
                line-height: 1.1;
            }

            #main-content {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
                padding: 1px;
                margin: 0;
                background: transparent;
                border-radius: 0;
                box-shadow: none;
            }

            #map-actions-container {
                flex: 1;
                min-height: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            #action-panel {
                margin-top: 2px;
                gap: 2px;
                width: 100%;
                max-width: 280px;
                grid-template-columns: repeat(3, 1fr);
            }

            /* Quest - hidden on main page, only in menu */
            #quest-panel {
                display: none !important;
            }

            .quest-title {
                display: none;
            }

            #family-section {
                padding: 1px;
                margin: 0;
                font-size: 5px;
            }

            /* Hide button text on mobile */
            #game-header button {
                display: none;
            }
        }

        /* Default weather display */
        #weather-display {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 6px 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        /* Header */
        #game-header {
            background: rgba(250, 247, 240, 0.95);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background 0.5s ease, color 0.5s ease;
        }

        #game-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #667eea;
        }

        /* Stats Panel */
        #stats-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .stat-bar {
            background: #f5f3ed;
            border-radius: 8px;
            padding: 8px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .bar-container {
            background: #e0ddd4;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .health-bar { background: linear-gradient(90deg, #ff6b6b, #ee5a6f); }
        .hunger-bar { background: linear-gradient(90deg, #f9ca24, #f0932b); }
        .energy-bar { background: linear-gradient(90deg, #6c5ce7, #a29bfe); }

        /* Season Info */
        #season-info {
            text-align: center;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            transition: background 0.5s ease, color 0.5s ease;
        }

        #level-info {
            text-align: center;
            background: #34495e;
            color: white;
            padding: 8px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 5px;
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* Main Content Area */
        #main-content {
            background: rgba(250, 247, 240, 0.95);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* Canvas Map */
        #map-canvas {
            display: block;
            cursor: pointer;
            touch-action: manipulation;
            width: 400px;
            height: 400px;
            max-width: 100%;
            max-height: 100%;
        }

        /* Map and Actions Container - side by side on desktop */
        #map-actions-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
            width: 100%;
        }

        #map-wrapper {
            flex-shrink: 0;
            width: fit-content;
            max-width: 100%;
        }

        #action-panel {
            width: 100%;
        }

        /* Message Log */
        #message-log {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 8px;
            max-height: 70px;
            overflow-y: auto;
            margin-bottom: 8px;
            font-size: 11px;
            line-height: 1.3;
            transition: background 0.5s ease, color 0.5s ease;
        }

        .message {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #3498db;
            padding-left: 8px;
            animation: fadeInUp 0.4s ease-out;
        }

        .message.success { border-left-color: #2ecc71; }
        .message.danger { border-left-color: #e74c3c; }
        .message.warning { border-left-color: #f39c12; }
        .message.info { border-left-color: #3498db; }

        /* Action Buttons */
        #action-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 3px;
            font-size: 9px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .action-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .action-btn:active:not(:disabled) {
            transform: scale(0.95);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(50%);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .action-btn.success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .action-btn.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn-emoji {
            font-size: 16px;
        }

        .btn-text {
            font-size: 10px;
        }

        /* Dice Roller Modal */
        #dice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        #dice-modal.active {
            display: flex;
        }

        .dice-container {
            background: #faf7f0;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        #dice-display {
            font-size: 80px;
            margin: 15px 0;
            animation: roll 0.5s ease;
        }

        @media (max-width: 599px) {
            .dice-container {
                padding: 15px;
                max-width: 95%;
                border-radius: 12px;
            }

            #dice-display {
                font-size: 60px;
                margin: 10px 0;
            }

            #dice-title {
                font-size: 12px !important;
                margin-bottom: 5px !important;
                line-height: 1.3;
            }

            #dice-result {
                font-size: 11px !important;
                margin: 8px 0 !important;
                line-height: 1.4;
            }
        }

        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }

        @keyframes critSuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        @keyframes critFail {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .crit-success {
            animation: critSuccess 0.6s ease;
            color: #2ecc71;
            text-shadow: 0 0 20px #2ecc71;
        }

        .crit-fail {
            animation: critFail 0.6s ease;
            color: #e74c3c;
        }

        #dice-result {
            font-size: 14px;
            font-weight: bold;
            margin: 12px 0;
            line-height: 1.4;
        }

        #dice-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        /* Quest Panel */
        #quest-panel {
            background: rgba(255, 243, 205, 0.5);
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 3px 5px;
            margin-bottom: 2px;
            font-size: 8px;
            transition: background 0.5s ease, color 0.5s ease;
        }

        .quest-title {
            font-weight: bold;
            font-size: 9px;
            margin-bottom: 2px;
            color: #856404;
            transition: color 0.5s ease;
        }

        .quest-item {
            font-size: 8px;
            padding: 2px;
            margin: 2px 0;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 3px;
            border-left: 2px solid #ffc107;
            padding-left: 4px;
            line-height: 1.2;
        }

        /* Modal/Dialog */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #faf7f0;
            border-radius: 15px;
            padding: 25px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: #667eea;
            color: white;
        }

        .modal-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        /* Combat Screen */
        #combat-screen {
            text-align: center;
        }

        .enemy-display {
            font-size: 80px;
            margin: 20px 0;
        }

        .enemy-health {
            background: #e74c3c;
            height: 30px;
            border-radius: 15px;
            margin: 10px 0;
            transition: width 0.3s;
        }

        .combat-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        /* Responsive */
        @media (min-width: 600px) {
            #stats-panel {
                grid-template-columns: repeat(4, 1fr);
            }

            #action-panel {
                grid-template-columns: 1fr; /* Changed from 2 to 1 column */
                max-width: 200px; /* Limit width */
            }

            /* Side-by-side layout on desktop */
            #map-actions-container {
                flex-direction: row;
                align-items: flex-start;
                gap: 12px;
            }

            #map-wrapper {
                flex-shrink: 0;
            }

            #map-canvas {
                width: 400px;
                height: 400px;
            }

            #action-panel {
                flex: 0 0 auto; /* Don't grow or shrink */
                width: 200px; /* Fixed narrow width */
            }
        }

        /* Inventory */
        #inventory {
            background: rgba(76, 175, 80, 0.1);
            border-radius: 4px;
            padding: 3px 6px;
            margin-bottom: 3px;
            font-size: 9px;
        }

        .inventory-title {
            font-weight: bold;
            margin-bottom: 2px;
            color: #2e7d32;
            font-size: 9px;
        }

        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .inventory-item {
            display: inline-block;
            padding: 1px 3px;
            border-radius: 3px;
            font-size: 9px;
            background: rgba(255, 255, 255, 0.5);
        }

        /* Skills Display */
        #skills-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 10px 0;
            font-size: 12px;
        }

        .skill-item {
            background: #f5f3ed;
            padding: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }

        .skill-level {
            font-weight: bold;
            color: #667eea;
        }

        /* Stats Grid in Header */
        #stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin: 8px 0;
        }

        .stat-compact {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 9px;
        }

        .stat-compact-label {
            font-weight: bold;
            display: none; /* Hidden by default, shown only in floating window */
            align-items: center;
            gap: 2px;
        }

        .inventory-item-label {
            display: none; /* Hidden by default, shown only in floating window */
        }

        .stat-compact-value {
            font-weight: bold;
            color: #667eea;
        }

        /* ===== FLOATING WINDOW SYSTEM ===== */

        /* Launch Button */
        .rpg-launcher-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .rpg-launcher-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .rpg-launcher-btn:active {
            transform: translateY(0);
        }

        /* Floating Window Container */
        .bird-rpg-float {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            filter: drop-shadow(0 10px 40px rgba(0, 0, 0, 0.5));
        }

        .bird-rpg-float.minimized {
            top: auto;
            left: auto;
            right: 20px;
            bottom: 20px;
            transform: none;
        }

        /* Handheld Device Frame */
        .bird-rpg-device {
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border: 3px solid #0a0a0a;
            border-radius: 20px;
            padding: 8px;
            box-shadow:
                0 0 0 2px #333,
                inset 0 2px 5px rgba(255, 255, 255, 0.1),
                inset 0 -2px 5px rgba(0, 0, 0, 0.5);
            width: 460px;
        }

        /* Title Bar */
        .rpg-titlebar {
            background: linear-gradient(180deg, #3a3a3a, #2a2a2a);
            border-radius: 12px 12px 0 0;
            padding: 6px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
            margin-bottom: 4px;
        }

        .rpg-titlebar-text {
            color: #e0e0e0;
            font-size: 11px;
            font-weight: bold;
        }

        .rpg-controls {
            display: flex;
            gap: 4px;
        }

        .rpg-control-btn {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: all 0.2s ease;
        }

        #rpg-minimize {
            background: #f5c542;
            color: #333;
        }

        #rpg-minimize:hover {
            background: #f5d142;
            transform: scale(1.1);
        }

        #rpg-close {
            background: #ff5f57;
            color: white;
        }

        #rpg-close:hover {
            background: #ff6f67;
            transform: scale(1.1);
        }

        /* Device Screen */
        .bird-rpg-screen {
            background: #000;
            border: 2px solid #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8);
            position: relative;
            transition: background 0.5s ease, box-shadow 0.5s ease;
            width: 100%;
            height: 100%;
        }

        /* ===== FRESH CLEAN DESIGN FOR FLOATING WINDOW ===== */

        /* Game container */
        .bird-rpg-float #game-container {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 12px !important;
            max-height: 680px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            background: transparent !important;
            display: block !important;
            flex-direction: initial !important;
            position: relative;
            z-index: 10;
        }

        /* Custom scrollbar */
        .bird-rpg-float #game-container::-webkit-scrollbar {
            width: 8px;
        }

        .bird-rpg-float #game-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .bird-rpg-float #game-container::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.6);
            border-radius: 4px;
        }

        /* === HEADER === */
        .bird-rpg-float #game-header {
            background: white !important;
            border-radius: 8px !important;
            padding: 14px !important;
            margin-bottom: 10px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            flex-shrink: initial !important;
            color: #2d3436 !important;
        }

        /* Hide title and buttons - titlebar has this */
        .bird-rpg-float #game-title,
        .bird-rpg-float #game-header > div:first-of-type {
            display: none !important;
        }

        /* Show header buttons in floating window */
        .bird-rpg-float #game-header button {
            display: inline-block !important;
        }

        /* Info line - uniform style */
        .bird-rpg-float #game-header > div:nth-child(3) {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 10px !important;
            padding: 8px 10px !important;
            background: rgba(102, 126, 234, 0.06) !important;
            border-radius: 6px !important;
        }

        .bird-rpg-float #season-info,
        .bird-rpg-float #level-info,
        .bird-rpg-float #action-info {
            display: inline-block !important;
            font-size: 11px !important;
            padding: 0 !important;
            margin: 0 !important;
            font-weight: 500 !important;
            background: transparent !important;
            color: #2d3436 !important;
        }

        /* Stats - uniform grid */
        .bird-rpg-float #game-header > div:nth-child(4) {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 8px !important;
            margin: 10px 0 !important;
        }

        .bird-rpg-float #stats-grid {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 8px !important;
        }

        .bird-rpg-float .stat-compact {
            font-size: 11px !important;
            padding: 8px 10px !important;
            background: rgba(102, 126, 234, 0.06) !important;
            border-radius: 6px !important;
            font-weight: 500 !important;
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            color: #2d3436 !important;
        }

        .bird-rpg-float .stat-compact-label {
            display: inline !important;
            opacity: 0.8 !important;
            color: #2d3436 !important;
        }

        .bird-rpg-float .stat-compact-value {
            font-size: 12px !important;
            font-weight: 600 !important;
            margin-left: auto !important;
            color: #667eea !important;
        }

        /* Inventory - uniform style */
        .bird-rpg-float #inventory {
            display: flex !important;
            justify-content: center !important;
            gap: 8px !important;
            margin-top: 10px !important;
            padding: 8px 10px !important;
            background: rgba(76, 175, 80, 0.06) !important;
            border-radius: 6px !important;
            color: #2d3436 !important;
        }

        .bird-rpg-float .inventory-title {
            display: none !important;
        }

        .bird-rpg-float .inventory-item {
            display: flex !important;
            align-items: center !important;
            gap: 5px !important;
            font-size: 11px !important;
            margin: 0 !important;
            padding: 0 !important;
            background: transparent !important;
            border-radius: 0 !important;
            font-weight: 500 !important;
            color: #2d3436 !important;
        }

        .bird-rpg-float .inventory-item-label {
            opacity: 0.8 !important;
            margin-right: 3px !important;
            color: #2d3436 !important;
        }

        /* === MAIN CONTENT === */
        .bird-rpg-float #main-content {
            background: white !important;
            border-radius: 8px !important;
            padding: 12px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            flex: initial !important;
            display: block !important;
            min-height: initial !important;
        }

        .bird-rpg-float #map-actions-container {
            display: block !important;
            flex: initial !important;
            min-height: initial !important;
            align-items: initial !important;
            justify-content: initial !important;
            margin: 0 !important;
        }

        /* Hide quest panel from main screen - only in character sheet */
        .bird-rpg-float #quest-panel {
            display: none !important;
        }

        /* Weather */
        .bird-rpg-float #weather-display {
            text-align: center !important;
            font-size: 11px !important;
            padding: 8px 10px !important;
            background: linear-gradient(135deg, rgba(227, 242, 253, 0.8), rgba(187, 222, 251, 0.8)) !important;
            border-radius: 6px !important;
            margin-bottom: 8px !important;
            font-weight: 600 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 6px !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06) !important;
        }

        .bird-rpg-float #weather-icon {
            font-size: 16px !important;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1)) !important;
        }

        /* Message log */
        .bird-rpg-float #message-log {
            background: #2c3e50 !important;
            color: #ecf0f1 !important;
            border-radius: 6px !important;
            padding: 8px !important;
            max-height: 50px !important;
            overflow-y: auto !important;
            margin-bottom: 10px !important;
            margin: 0 0 10px 0 !important;
            font-size: 10px !important;
            line-height: 1.4 !important;
        }

        .bird-rpg-float .message {
            font-size: 10px !important;
            margin-bottom: 4px !important;
            padding: 1px !important;
            color: #ecf0f1 !important;
        }

        /* === MAP === */
        .bird-rpg-float #map-wrapper {
            width: 340px !important;
            margin: 0 auto 8px auto !important;
        }

        .bird-rpg-float #map-canvas {
            width: 340px !important;
            height: 340px !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
        }

        /* === ACTION BUTTONS === */
        .bird-rpg-float #action-panel {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 8px !important;
            margin-top: 10px !important;
            width: 100% !important;
            max-width: none !important;
        }

        /* Quick Stats Reference */
        .bird-rpg-float #quick-stats-ref {
            display: flex !important;
            justify-content: space-between !important;
            margin-top: 10px !important;
            padding: 8px 10px !important;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.12), rgba(118, 75, 162, 0.12)) !important;
            border-radius: 8px !important;
            font-size: 10px !important;
            gap: 6px !important;
            border: 1px solid rgba(102, 126, 234, 0.2) !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08) !important;
        }

        .bird-rpg-float .quick-stat-item {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            gap: 3px !important;
            flex: 1 !important;
            padding: 4px !important;
            background: rgba(255, 255, 255, 0.5) !important;
            border-radius: 6px !important;
            transition: transform 0.2s ease !important;
        }

        .bird-rpg-float .quick-stat-item:hover {
            transform: translateY(-2px) !important;
            background: rgba(255, 255, 255, 0.7) !important;
        }

        .bird-rpg-float .quick-stat-icon {
            font-size: 16px !important;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1)) !important;
        }

        .bird-rpg-float .quick-stat-value {
            font-size: 11px !important;
            font-weight: 700 !important;
            color: #2d3436 !important;
            transition: color 0.3s ease !important;
        }

        /* Color-coded stat values */
        .bird-rpg-float .quick-stat-value.stat-critical {
            color: #e74c3c !important;
            animation: pulse-critical 1.5s ease-in-out infinite !important;
        }

        .bird-rpg-float .quick-stat-value.stat-low {
            color: #f39c12 !important;
        }

        .bird-rpg-float .quick-stat-value.stat-good {
            color: #27ae60 !important;
        }

        @keyframes pulse-critical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .bird-rpg-float .action-btn {
            padding: 10px 6px !important;
            min-height: 60px !important;
            border-radius: 7px !important;
            font-size: 10px !important;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            cursor: pointer !important;
        }

        .bird-rpg-float .action-btn:hover:not(:disabled) {
            transform: translateY(-3px) !important;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25) !important;
        }

        .bird-rpg-float .action-btn:active:not(:disabled) {
            transform: translateY(-1px) scale(0.98) !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2) !important;
        }

        .bird-rpg-float .action-btn:disabled {
            opacity: 0.4 !important;
            cursor: not-allowed !important;
            filter: grayscale(60%) !important;
            transform: none !important;
        }

        .bird-rpg-float .action-btn:disabled::after {
            content: 'üîí' !important;
            position: absolute !important;
            top: 4px !important;
            right: 4px !important;
            font-size: 10px !important;
            opacity: 0.6 !important;
        }

        .bird-rpg-float .btn-emoji {
            font-size: 22px !important;
            margin-bottom: 3px !important;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2)) !important;
            transition: transform 0.2s ease !important;
        }

        .bird-rpg-float .action-btn:hover:not(:disabled) .btn-emoji {
            transform: scale(1.1) !important;
        }

        .bird-rpg-float .btn-text {
            font-size: 11px !important;
            line-height: 1.3 !important;
            font-weight: 600 !important;
        }

        /* Helpful hint box */
        .bird-rpg-float #hint-box {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.15), rgba(41, 128, 185, 0.15)) !important;
            border: 1px solid rgba(52, 152, 219, 0.3) !important;
            border-radius: 6px !important;
            padding: 8px 10px !important;
            margin: 0 0 10px 0 !important;
            font-size: 10px !important;
            line-height: 1.4 !important;
            color: #2c3e50 !important;
            position: relative !important;
        }

        .bird-rpg-float #hint-box::before {
            content: 'üí°' !important;
            margin-right: 4px !important;
            font-size: 12px !important;
        }

        .bird-rpg-float .hint-close {
            position: absolute !important;
            top: 4px !important;
            right: 6px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            opacity: 0.6 !important;
            transition: opacity 0.2s !important;
        }

        .bird-rpg-float .hint-close:hover {
            opacity: 1 !important;
        }

        /* Family section */
        .bird-rpg-float #family-section {
            font-size: 11px !important;
            padding: 10px !important;
            margin: 0 0 10px 0 !important;
            border-radius: 6px !important;
        }

        /* === MODALS & MENUS === */
        .bird-rpg-float .modal-content {
            max-width: 400px;
            max-height: 540px;
            padding: 18px;
            font-size: 11px;
        }

        .bird-rpg-float .modal-content h2 {
            font-size: 16px;
            margin-bottom: 12px;
        }

        .bird-rpg-float .modal-content h3 {
            font-size: 13px;
            margin-top: 10px;
            margin-bottom: 8px;
        }

        .bird-rpg-float .modal-content p,
        .bird-rpg-float .modal-content div {
            font-size: 11px;
            line-height: 1.5;
        }

        .bird-rpg-float .modal-content button {
            font-size: 11px;
            padding: 8px 14px;
            margin: 5px;
        }

        /* Dice roll modal */
        .bird-rpg-float #dice-emoji {
            font-size: 70px;
        }

        .bird-rpg-float .dice-roll-title {
            font-size: 16px;
        }

        .bird-rpg-float .dice-roll-result {
            font-size: 14px;
        }

        /* Quest items */
        .bird-rpg-float .quest-item {
            font-size: 10px;
            padding: 8px;
            margin: 5px 0;
        }

        .bird-rpg-float .progress-bar {
            height: 7px;
        }

        /* Minimized State */
        .bird-rpg-float.minimized .bird-rpg-device {
            width: 70px;
            height: 70px;
            padding: 4px;
        }

        .bird-rpg-float.minimized .rpg-titlebar {
            display: none;
        }

        .bird-rpg-float.minimized .bird-rpg-screen {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            overflow: hidden;
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a) !important;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5) !important;
        }

        .bird-rpg-float.minimized .bird-rpg-screen::before {
            content: 'üê¶';
            animation: birdBob 2s ease-in-out infinite;
            line-height: 1;
        }

        @keyframes birdBob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .bird-rpg-float.minimized #game-container {
            display: none;
        }

        .bird-rpg-float.minimized #day-night-indicator,
        .bird-rpg-float.minimized #stars-container {
            display: none;
        }

        /* Mobile adjustments FOR FLOATING WINDOW ONLY */
        @media (max-width: 599px) {
            .rpg-launcher-btn {
                bottom: 10px !important;
                right: 10px !important;
                padding: 10px 16px !important;
                font-size: 14px !important;
            }

            .bird-rpg-device {
                width: 400px !important;
            }

            .bird-rpg-float {
                top: 10px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
            }

            .bird-rpg-float.minimized {
                top: auto !important;
                left: auto !important;
                right: 10px !important;
                bottom: 10px !important;
                transform: none !important;
            }

            .bird-rpg-float.minimized .bird-rpg-device {
                width: 60px !important;
                height: 60px !important;
                padding: 3px !important;
            }

            .bird-rpg-float.minimized .bird-rpg-screen {
                font-size: 28px !important;
            }

            .bird-rpg-float #game-container {
                max-height: 560px !important;
            }

            .bird-rpg-float #map-wrapper {
                width: 340px !important;
            }

            .bird-rpg-float #map-canvas {
                width: 340px !important;
                height: 340px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Launch Button -->
    <button id="bird-rpg-launcher" class="rpg-launcher-btn">
        üê¶ Bird RPG
    </button>

    <!-- Floating Window Container -->
    <div id="bird-rpg-float" class="bird-rpg-float" style="display: none;">
        <!-- Device Frame -->
        <div class="bird-rpg-device">
            <!-- Title Bar with Controls -->
            <div class="rpg-titlebar" id="rpg-titlebar">
                <span class="rpg-titlebar-text">üê¶ Bird Window RPG</span>
                <div class="rpg-controls">
                    <button class="rpg-control-btn" id="rpg-minimize" title="Minimize">‚àí</button>
                    <button class="rpg-control-btn" id="rpg-close" title="Close">√ó</button>
                </div>
            </div>

            <!-- Device Screen -->
            <div class="bird-rpg-screen">
                <!-- Day/Night Indicator (inside widget) -->
                <div id="day-night-indicator">‚òÄÔ∏è</div>

                <!-- Stars for Night Mode (inside widget) -->
                <div id="stars-container" class="stars"></div>

                <div id="game-container">
        <!-- Header -->
        <div id="game-header">
            <div id="game-title">üê¶ BIRD WINDOW RPG</div>

            <!-- Quick Actions Bar -->
            <div style="display: flex; gap: 4px; margin: 3px 0;">
                <button onclick="newGame()" style="flex: 1; padding: 4px; background: #e74c3c; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 9px;">üîÑ New</button>
                <button onclick="showTutorial(0)" style="flex: 1; padding: 4px; background: #3498db; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 9px;">‚ùì Help</button>
            </div>

            <!-- Season, Level & Action Info (Combined) -->
            <div style="text-align: center; margin: 2px 0;">
                <span id="season-info" style="display: inline-block;">üå∏ Spring - Turn 1/10</span>
                <span id="level-info" style="display: inline-block;">Level 1 Bluebird | XP: 0/100</span>
                <span id="action-info" style="display: inline-block; font-weight: bold; color: #2980b9;">‚ö° Actions: 0/5</span>
            </div>

            <!-- Compact Stats & Inventory Combined -->
            <div style="display: flex; flex-wrap: wrap; gap: 3px; justify-content: center; margin: 2px 0; font-size: 9px;">
                <span class="stat-compact">‚ù§Ô∏è <span class="stat-compact-label">Health:</span><span class="stat-compact-value" id="header-health">100/100</span></span>
                <span class="stat-compact">‚ö° <span class="stat-compact-label">Energy:</span><span class="stat-compact-value" id="header-energy">100/100</span></span>
                <span class="stat-compact">üçñ <span class="stat-compact-label">Hunger:</span><span class="stat-compact-value" id="header-hunger">0/100</span></span>
                <span class="stat-compact">‚≠ê <span class="stat-compact-label">Social:</span><span class="stat-compact-value" id="header-social">50/100</span></span>
            </div>

            <div id="stats-grid" style="display: none;"></div>

            <!-- Inventory (Inline) -->
            <div id="inventory" style="text-align: center;">
                <span class="inventory-item">üå∞ <span class="inventory-item-label">Food:</span><span id="food-count">0</span></span>
                <span class="inventory-item">üåø <span class="inventory-item-label">Twigs:</span><span id="twig-count">0</span></span>
                <span class="inventory-item">ü•ö <span class="inventory-item-label">Eggs:</span><span id="egg-count">0</span></span>
                <span class="inventory-item">üì¶ <span class="inventory-item-label">Cached:</span><span id="cached-count">0</span></span>
            </div>

            <!-- Family Section -->
            <div id="family-section" style="display: none; background: linear-gradient(135deg, #ffeef8, #ffe6f0); padding: 10px; border-radius: 10px; margin-bottom: 10px; transition: background 0.5s ease, color 0.5s ease;">
                <div style="font-weight: bold; font-size: 14px; margin-bottom: 8px; color: #c0392b;">üíï Family</div>
                <div id="family-content" style="font-size: 12px; line-height: 1.6;"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Quest Panel -->
            <div id="quest-panel" style="display: none;">
                <div class="quest-title">üìú Active Quest</div>
                <div id="quest-content"></div>
            </div>

            <!-- Skills (hidden by default, shown in character screen) -->
            <div id="skills-display" style="display: none;">
                <div class="skill-item"><span>üîç Foraging</span><span class="skill-level" id="skill-foraging">1</span></div>
                <div class="skill-item"><span>üèóÔ∏è Building</span><span class="skill-level" id="skill-building">1</span></div>
                <div class="skill-item"><span>ü¶Ö Flying</span><span class="skill-level" id="skill-flying">1</span></div>
                <div class="skill-item"><span>‚öîÔ∏è Combat</span><span class="skill-level" id="skill-combat">1</span></div>
                <div class="skill-item"><span>üë• Flocking</span><span class="skill-level" id="skill-flocking">1</span></div>
                <div class="skill-item"><span>üëÅÔ∏è Perception</span><span class="skill-level" id="skill-perception">1</span></div>
            </div>

            <!-- Helpful Hint -->
            <div id="hint-box" style="display: none;">
                <span class="hint-close" onclick="document.getElementById('hint-box').style.display='none'">‚úï</span>
                <span id="hint-text">Hover over action buttons to see what they do!</span>
            </div>

            <!-- Weather Display -->
            <div id="weather-display">
                <span id="weather-icon">‚òÄÔ∏è</span>
                <span id="weather-text">Clear skies</span>
            </div>

            <!-- Message Log -->
            <div id="message-log"></div>

            <!-- Map and Actions Container -->
            <div id="map-actions-container">
                <!-- Canvas Map (Visual) -->
                <div id="map-wrapper">
                    <canvas id="map-canvas" width="400" height="400" style="border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></canvas>
                </div>

                <!-- Action Panel -->
                <div id="action-panel"></div>

                <!-- Quick Stats Reference -->
                <div id="quick-stats-ref">
                    <div class="quick-stat-item">
                        <span class="quick-stat-icon">‚ù§Ô∏è</span>
                        <span class="quick-stat-value" id="quick-health">100/100</span>
                    </div>
                    <div class="quick-stat-item">
                        <span class="quick-stat-icon">‚ö°</span>
                        <span class="quick-stat-value" id="quick-energy">100/100</span>
                    </div>
                    <div class="quick-stat-item">
                        <span class="quick-stat-icon">üçñ</span>
                        <span class="quick-stat-value" id="quick-hunger">0/100</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
            </div><!-- .bird-rpg-screen -->
        </div><!-- .bird-rpg-device -->
    </div><!-- .bird-rpg-float -->

    <!-- Dice Roll Modal -->
    <div id="dice-modal">
        <div class="dice-container">
            <div id="dice-title"></div>
            <div id="dice-display">üé≤</div>
            <div id="dice-result"></div>
            <button class="modal-btn primary" onclick="closeDiceModal()" style="margin-top: 10px; padding: 8px 16px;">Continue</button>
        </div>
    </div>

    <!-- Generic Modal -->
    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modal-title"></div>
            <div id="modal-body"></div>
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>

    <script>
        // ===== FLOATING WINDOW SYSTEM =====
        (function() {
            const launcher = document.getElementById('bird-rpg-launcher');
            const floatWindow = document.getElementById('bird-rpg-float');
            const titlebar = document.getElementById('rpg-titlebar');
            const minimizeBtn = document.getElementById('rpg-minimize');
            const closeBtn = document.getElementById('rpg-close');
            const screen = document.querySelector('.bird-rpg-screen');

            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;

            // Open window
            launcher.addEventListener('click', function() {
                floatWindow.style.display = 'block';
                launcher.style.display = 'none';
            });

            // Close window
            closeBtn.addEventListener('click', function() {
                floatWindow.style.display = 'none';
                launcher.style.display = 'block';
            });

            // Minimize/Maximize
            minimizeBtn.addEventListener('click', function() {
                floatWindow.classList.toggle('minimized');
            });

            // Click minimized icon to maximize
            screen.addEventListener('click', function(e) {
                if (floatWindow.classList.contains('minimized')) {
                    floatWindow.classList.remove('minimized');
                }
            });

            // Dragging functionality
            titlebar.addEventListener('mousedown', dragStart);
            titlebar.addEventListener('touchstart', dragStart);

            function dragStart(e) {
                if (floatWindow.classList.contains('minimized')) return;

                if (e.type === 'touchstart') {
                    initialX = e.touches[0].clientX - floatWindow.offsetLeft;
                    initialY = e.touches[0].clientY - floatWindow.offsetTop;
                } else {
                    initialX = e.clientX - floatWindow.offsetLeft;
                    initialY = e.clientY - floatWindow.offsetTop;
                }

                isDragging = true;
            }

            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);

            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();

                if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }

                floatWindow.style.left = currentX + 'px';
                floatWindow.style.top = currentY + 'px';
                floatWindow.style.transform = 'none';
            }

            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchend', dragEnd);

            function dragEnd() {
                isDragging = false;
            }
        })();

        // ===== GAME STATE =====
        const SEASONS = ['Spring', 'Summer', 'Fall', 'Winter'];
        const SEASON_EMOJIS = { Spring: 'üå∏', Summer: '‚òÄÔ∏è', Fall: 'üçÇ', Winter: '‚ùÑÔ∏è' };
        const TURNS_PER_SEASON = 10;

        // Bird species with unique attributes
        const BIRD_SPECIES = {
            'Bluebird': {
                name: 'Bluebird',
                emoji: 'üê¶',
                color: '#3498db',
                description: 'Balanced and reliable',
                startingSkills: { foraging: 1, building: 1, flying: 2, combat: 1, flocking: 1, perception: 1 },
                bonuses: { health: 0, energy: 0, socialStanding: 0 }
            },
            'Cardinal': {
                name: 'Cardinal',
                emoji: 'üî¥',
                color: '#e74c3c',
                description: 'Strong and aggressive',
                startingSkills: { foraging: 1, building: 1, flying: 1, combat: 3, flocking: 0, perception: 1 },
                bonuses: { health: 20, energy: -10, socialStanding: -10 }
            },
            'Canary': {
                name: 'Canary',
                emoji: 'üü°',
                color: '#f1c40f',
                description: 'Fast and energetic',
                startingSkills: { foraging: 2, building: 0, flying: 3, combat: 0, flocking: 1, perception: 2 },
                bonuses: { health: -10, energy: 20, socialStanding: 0 }
            },
            'Sparrow': {
                name: 'Sparrow',
                emoji: 'üü§',
                color: '#9c640c',
                description: 'Social and cooperative',
                startingSkills: { foraging: 2, building: 1, flying: 1, combat: 0, flocking: 3, perception: 1 },
                bonuses: { health: 0, energy: 0, socialStanding: 20 }
            },
            'Robin': {
                name: 'Robin',
                emoji: 'üî∂',
                color: '#e67e22',
                description: 'Resourceful forager',
                startingSkills: { foraging: 3, building: 2, flying: 1, combat: 1, flocking: 1, perception: 0 },
                bonuses: { health: 10, energy: 0, socialStanding: 0 }
            }
        };

        let gameState = {
            // Character
            species: 'Bluebird',
            level: 1,
            xp: 0,
            xpNeeded: 100,

            // Stats
            health: 100,
            maxHealth: 100,
            hunger: 0,
            energy: 100,
            maxEnergy: 100,
            socialStanding: 50,

            // Skills (1-10)
            skills: {
                foraging: 1,
                building: 1,
                flying: 1,
                combat: 1,
                flocking: 1,
                perception: 1
            },

            // Inventory
            food: 0,
            twigs: 0,
            eggs: 0,
            cachedFood: 0,
            foodCaches: [], // {location, amount, turnsLeft}
            mushroomFound: false,

            // World
            season: 0, // 0=Spring, 1=Summer, 2=Fall, 3=Winter
            turn: 1,
            year: 1,
            currentLocation: 4, // Center of 3x3 grid (0-8)
            weather: 'clear', // clear, rain, storm, snow, wind
            weatherIntensity: 0, // 0-1
            timeOfDay: 'day', // day/night

            // Life Story Diary
            diary: [],
            totalDistance: 0,

            // Progress
            hasNest: false,
            hasBirdhouse: false,
            nestProgress: 0, // 0-10 twigs for nest, 0-15 for birdhouse
            nestType: null, // 'nest' or 'birdhouse'
            hasMate: false,
            mateSpecies: null, // Species of mate
            mateRelationship: 0, // 0-100 relationship level
            courtshipProgress: 0, // 0-3 stages (met, interested, courting, bonded)
            offspring: 0,
            babies: [], // {name, age, stage, hunger, species}
            eggsLaid: 0, // Number of eggs laid this season
            incubationTurns: 0, // Turns eggs have been incubating (need 5 turns)
            ratsDefeated: 0,

            // Quests
            activeQuests: [],
            completedQuests: [],

            // NPCs and Enemies
            territories: [],

            // Flags
            isInCombat: false,
            combatEnemy: null,
            gameOver: false,
            hasSeenIntro: false,

            // Tutorial
            tutorialStep: 0,
            tutorialActive: false,

            // Phase 2 Features
            mushroomModeActive: false,
            mushroomModeTurns: 0,
            flockMembers: [], // {species, emoji, skill}
            ufoEncounterHappened: false,
            lastUFOTurn: -999,

            // Phase 2.5 Features
            hasWindChimes: false,
            windChimesInstalled: false,
            visitedPondThisTurn: false,
            frogFriendship: 0, // 0-100

            // Turn Management
            actionsTakenThisTurn: 0,
            maxActionsPerTurn: 5,
            turnEndPending: false
        };

        // Territory definitions (3x3 grid, 0-8)
        const TERRITORIES = [
            { id: 0, name: 'Pine Forest', emoji: 'üå≤', resources: ['twig', 'seed'], danger: 0.1 },
            { id: 1, name: 'Mountain Peak', emoji: '‚õ∞Ô∏è', resources: ['stone'], danger: 0.3 },
            { id: 2, name: 'Berry Patch', emoji: 'ü´ê', resources: ['berry', 'berry'], danger: 0.1 },
            { id: 3, name: 'Birch Grove', emoji: 'üå≥', resources: ['twig', 'worm'], danger: 0.1 },
            { id: 4, name: 'Oak Meadow', emoji: 'üå≥', resources: ['twig', 'seed', 'worm'], danger: 0.05 },
            { id: 5, name: 'Willow Pond', emoji: 'üíß', resources: ['worm', 'insect'], danger: 0.2 },
            { id: 6, name: 'Flower Field', emoji: 'üåª', resources: ['seed', 'insect'], danger: 0.05 },
            { id: 7, name: 'Ancient Oak', emoji: 'üå≥', resources: ['twig', 'twig'], danger: 0.15 },
            { id: 8, name: 'Rock Garden', emoji: 'ü™®', resources: ['seed'], danger: 0.2 }
        ];

        // Initialize territories with random NPCs and items
        function initTerritories() {
            gameState.territories = TERRITORIES.map(t => ({
                ...t,
                npcs: [],
                predators: [],
                visibleFood: Math.random() > 0.5 ? Math.floor(Math.random() * 3) : 0,
                visibleTwigs: Math.random() > 0.6 ? Math.floor(Math.random() * 2) : 0
            }));

            // Add some NPCs
            for (let i = 0; i < 5; i++) {
                const randomLoc = Math.floor(Math.random() * 9);
                if (randomLoc !== 4) { // Don't spawn on player start
                    gameState.territories[randomLoc].npcs.push({
                        species: ['Cardinal', 'Sparrow', 'Robin'][Math.floor(Math.random() * 3)],
                        emoji: ['üê¶', 'ü¶Ö', 'üê¶‚Äç‚¨õ'][Math.floor(Math.random() * 3)]
                    });
                }
            }
        }

        // ===== SAVE/LOAD =====
        function saveGame() {
            try {
                localStorage.setItem('seasonsOfTheFlock_save', JSON.stringify(gameState));
            } catch(e) {
                console.error('Failed to save game:', e);
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('seasonsOfTheFlock_save');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    // Merge with defaults in case of new properties
                    gameState = { ...gameState, ...loaded };

                    // Deep merge nested objects to handle new properties
                    if (loaded.skills) {
                        gameState.skills = { ...gameState.skills, ...loaded.skills };
                    }

                    // Migrate old saves: ensure babies have species property
                    if (gameState.babies && gameState.babies.length > 0) {
                        gameState.babies = gameState.babies.map(baby => ({
                            ...baby,
                            species: baby.species || gameState.species
                        }));
                    }

                    // Ensure new flags exist
                    if (gameState.turnEndPending === undefined) {
                        gameState.turnEndPending = false;
                    }

                    return true;
                }
            } catch(e) {
                console.error('Failed to load game:', e);
            }
            return false;
        }

        function newGame() {
            localStorage.removeItem('seasonsOfTheFlock_save');
            location.reload();
        }

        // ===== UI UPDATES =====
        function updateUI() {
            // Update day/night background colors
            const screen = document.querySelector('.bird-rpg-screen');
            const header = document.getElementById('game-header');
            const mainContent = document.getElementById('main-content');
            const messageLog = document.getElementById('message-log');
            const isMobile = window.innerWidth <= 599;

            // Get additional UI elements
            const seasonInfo = document.getElementById('season-info');
            const levelInfo = document.getElementById('level-info');
            const questPanel = document.getElementById('quest-panel');
            const familySection = document.getElementById('family-section');
            const dayNightIndicator = document.getElementById('day-night-indicator');
            const starsContainer = document.getElementById('stars-container');

            if (gameState.timeOfDay === 'day') {
                // Show sun indicator
                if (dayNightIndicator) {
                    dayNightIndicator.textContent = '‚òÄÔ∏è';
                    dayNightIndicator.style.textShadow = '0 0 20px rgba(255, 200, 0, 0.8), 0 0 30px rgba(255, 200, 0, 0.5)';
                }
                // Hide stars
                if (starsContainer) {
                    starsContainer.classList.remove('active');
                }
                // Day: bright sky blue gradient with warm glow (applied to widget screen)
                if (screen) {
                    if (isMobile) {
                        screen.style.background = 'linear-gradient(180deg, #87CEEB 0%, #B0D8F0 50%, #FFE9B3 100%)';
                        screen.style.boxShadow = 'inset 0 0 100px rgba(255, 230, 100, 0.3)';
                    } else {
                        screen.style.background = 'linear-gradient(135deg, #87CEEB 0%, #B0D8F0 50%, #FFE9B3 100%)';
                        screen.style.boxShadow = 'inset 0 0 150px rgba(255, 230, 100, 0.2)';
                    }
                }
                header.style.background = 'rgba(250, 250, 250, 0.95)';
                header.style.color = '#2d3436';
                header.style.boxShadow = '0 4px 10px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8)';
                mainContent.style.background = 'rgba(250, 247, 240, 0.95)';
                mainContent.style.color = '#2d3436';
                mainContent.style.boxShadow = '0 4px 10px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8)';
                messageLog.style.background = 'rgba(44, 62, 80, 0.9)';
                messageLog.style.color = '#ecf0f1';

                // Day mode for season/level info
                seasonInfo.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                seasonInfo.style.color = 'white';
                levelInfo.style.background = '#34495e';
                levelInfo.style.color = 'white';

                // Day mode for quest and family panels
                if (questPanel) {
                    questPanel.style.background = 'linear-gradient(135deg, rgba(52, 152, 219, 0.15), rgba(41, 128, 185, 0.15))';
                    questPanel.style.color = '#2d3436';
                    // Reset quest titles for day mode
                    const questTitles = document.querySelectorAll('.quest-title');
                    questTitles.forEach(title => title.style.color = '#856404');
                }
                if (familySection && familySection.style.display !== 'none') {
                    familySection.style.background = 'linear-gradient(135deg, #ffeef8, #ffe6f0)';
                    familySection.style.color = '#2d3436';
                }
            } else {
                // Show moon indicator
                if (dayNightIndicator) {
                    dayNightIndicator.textContent = 'üåô';
                    dayNightIndicator.style.textShadow = '0 0 20px rgba(200, 200, 255, 0.8), 0 0 30px rgba(200, 200, 255, 0.5)';
                }
                // Show stars
                if (starsContainer) {
                    starsContainer.classList.add('active');
                }

                // Night: dark blue/purple gradient with stars and moonlit glow (applied to widget screen)
                if (screen) {
                    if (isMobile) {
                        screen.style.background = 'linear-gradient(180deg, #05061a 0%, #0c1445 30%, #1a1a2e 70%, #0a0a1a 100%)';
                        screen.style.boxShadow = 'inset 0 0 150px rgba(100, 100, 200, 0.4)';
                    } else {
                        screen.style.background = 'radial-gradient(ellipse at top, #1a1a3e 0%, #0c1445 30%, #050515 100%)';
                        screen.style.boxShadow = 'inset 0 0 200px rgba(100, 100, 200, 0.3)';
                    }
                }
                header.style.background = 'rgba(15, 20, 35, 0.95)';
                header.style.color = '#e0e0e0';
                header.style.boxShadow = '0 4px 20px rgba(0,0,0,0.5), inset 0 1px 0 rgba(100,100,200,0.3), 0 0 30px rgba(100,100,200,0.1)';
                mainContent.style.background = 'rgba(20, 25, 40, 0.95)';
                mainContent.style.color = '#e0e0e0';
                mainContent.style.boxShadow = '0 4px 20px rgba(0,0,0,0.5), inset 0 1px 0 rgba(100,100,200,0.3), 0 0 30px rgba(100,100,200,0.1)';
                messageLog.style.background = 'rgba(10, 15, 25, 0.9)';
                messageLog.style.color = '#d0d0d0';

                // Night mode for season/level info - darker with good contrast
                seasonInfo.style.background = 'linear-gradient(135deg, #6a4c93 0%, #4a3870 100%)';
                seasonInfo.style.color = '#f0f0f0';
                levelInfo.style.background = 'rgba(30, 35, 55, 0.95)';
                levelInfo.style.color = '#e0e0e0';

                // Night mode for quest and family panels
                if (questPanel) {
                    questPanel.style.background = 'linear-gradient(135deg, rgba(52, 152, 219, 0.25), rgba(41, 128, 185, 0.25))';
                    questPanel.style.color = '#e0e0e0';
                    // Update quest titles for night mode
                    const questTitles = document.querySelectorAll('.quest-title');
                    questTitles.forEach(title => title.style.color = '#ffd700');
                }
                if (familySection && familySection.style.display !== 'none') {
                    familySection.style.background = 'linear-gradient(135deg, rgba(139, 69, 139, 0.3), rgba(123, 63, 123, 0.3))';
                    familySection.style.color = '#e0e0e0';
                }
            }

            // Header Stats - Compact display in header
            document.getElementById('header-health').textContent = `${gameState.health}/${gameState.maxHealth}`;
            document.getElementById('header-hunger').textContent = `${gameState.hunger}/100`;
            document.getElementById('header-energy').textContent = `${gameState.energy}/${gameState.maxEnergy}`;
            document.getElementById('header-social').textContent = `${gameState.socialStanding}/100`;

            // Update quick stats reference with color coding
            const quickHealthEl = document.getElementById('quick-health');
            const quickEnergyEl = document.getElementById('quick-energy');
            const quickHungerEl = document.getElementById('quick-hunger');

            quickHealthEl.textContent = `${gameState.health}/${gameState.maxHealth}`;
            quickEnergyEl.textContent = `${gameState.energy}/${gameState.maxEnergy}`;
            quickHungerEl.textContent = `${gameState.hunger}/100`;

            // Color code based on thresholds
            const healthPercent = (gameState.health / gameState.maxHealth) * 100;
            quickHealthEl.className = 'quick-stat-value ' +
                (healthPercent <= 20 ? 'stat-critical' : healthPercent <= 50 ? 'stat-low' : 'stat-good');

            const energyPercent = (gameState.energy / gameState.maxEnergy) * 100;
            quickEnergyEl.className = 'quick-stat-value ' +
                (energyPercent <= 20 ? 'stat-critical' : energyPercent <= 50 ? 'stat-low' : 'stat-good');

            const hungerLevel = gameState.hunger;
            quickHungerEl.className = 'quick-stat-value ' +
                (hungerLevel >= 80 ? 'stat-critical' : hungerLevel >= 50 ? 'stat-low' : 'stat-good');

            // Season & Level
            const seasonName = SEASONS[gameState.season];
            const seasonEmoji = SEASON_EMOJIS[seasonName];
            document.getElementById('season-info').textContent =
                `${seasonEmoji} ${seasonName} - Turn ${gameState.turn}/${TURNS_PER_SEASON} | Year ${gameState.year} | ${gameState.timeOfDay === 'day' ? '‚òÄÔ∏è Day' : 'üåô Night'}`;

            document.getElementById('level-info').textContent =
                `Level ${gameState.level} ${gameState.species} | XP: ${gameState.xp}/${gameState.xpNeeded}`;

            // Action counter
            const actionsRemaining = gameState.maxActionsPerTurn - gameState.actionsTakenThisTurn;
            document.getElementById('action-info').textContent =
                `‚ö° Actions: ${actionsRemaining}/${gameState.maxActionsPerTurn}`;

            // Inventory
            document.getElementById('food-count').textContent = gameState.food;
            document.getElementById('twig-count').textContent = gameState.twigs;
            document.getElementById('egg-count').textContent = gameState.eggs;
            document.getElementById('cached-count').textContent = gameState.cachedFood;

            // Skills
            Object.keys(gameState.skills).forEach(skill => {
                const el = document.getElementById(`skill-${skill}`);
                if (el) el.textContent = gameState.skills[skill];
            });

            // Update actions and quests
            updateActions();
            updateQuests();
            updateFamilyDisplay();

            // Show helpful hints for new players
            updateHints();

            // Auto-save
            saveGame();
        }

        function updateHints() {
            const hintBox = document.getElementById('hint-box');
            const hintText = document.getElementById('hint-text');

            // Only show hints to newer players (first 20 turns)
            if (gameState.turn > 20) {
                hintBox.style.display = 'none';
                return;
            }

            let hint = '';

            // Contextual hints based on game state
            if (gameState.turn <= 3) {
                hint = 'Hover over action buttons to see what they do! Use Forage and Gather to collect resources.';
            } else if (gameState.turn <= 6 && !gameState.hasNest && gameState.twigs >= 1) {
                hint = 'You have twigs! Build a nest to unlock more features like resting and finding a mate.';
            } else if (gameState.energy < 30) {
                hint = 'Your energy is low! Rest to recover energy, or rest at your nest for faster recovery.';
            } else if (gameState.hunger > 70) {
                hint = 'You\'re very hungry! Eat food to reduce hunger and restore health.';
            } else if (gameState.health < 50) {
                hint = 'Your health is low! Eat food to recover health, and avoid risky actions.';
            } else if (gameState.turn > 8 && gameState.food > 5 && !gameState.hasNest) {
                hint = 'You have lots of food! Consider building a nest to progress in the game.';
            } else if (gameState.hasNest && gameState.socialStanding < 30) {
                hint = 'Try Socializing to increase your standing with other birds!';
            } else {
                // Default hint
                hint = 'Check the quick stats below actions to make informed decisions!';
            }

            if (hint) {
                hintText.textContent = hint;
                hintBox.style.display = 'block';
            } else {
                hintBox.style.display = 'none';
            }
        }

        function updateFamilyDisplay() {
            const familySection = document.getElementById('family-section');
            const familyContent = document.getElementById('family-content');

            if (gameState.hasMate || gameState.babies.length > 0 || gameState.eggs > 0) {
                familySection.style.display = 'block';
                let html = '';

                if (gameState.hasMate) {
                    html += `<div style="margin-bottom: 5px;">üíï Mate: ${gameState.mateSpecies} ${BIRD_SPECIES[gameState.mateSpecies].emoji}</div>`;
                }

                if (gameState.eggs > 0) {
                    html += `<div style="margin-bottom: 5px;">ü•ö ${gameState.eggs} egg${gameState.eggs > 1 ? 's' : ''} (${gameState.incubationTurns}/5 turns)</div>`;
                }

                if (gameState.babies.length > 0) {
                    html += `<div style="margin-top: 5px; padding-top: 5px; border-top: 1px solid #f8cce5;">üê£ Babies (${gameState.babies.length}):</div>`;
                    gameState.babies.forEach(baby => {
                        const stageEmoji = baby.stage === 'hatchling' ? 'üê£' : 'üê¶';
                        const hungerColor = baby.hunger > 70 ? '#e74c3c' : baby.hunger > 40 ? '#f39c12' : '#27ae60';
                        html += `<div style="margin-left: 10px; margin-top: 3px;">
                            ${stageEmoji} ${baby.name} (${baby.species}) - Age ${baby.age}<br/>
                            <span style="font-size: 11px;">Hunger: <span style="color: ${hungerColor};">${Math.round(baby.hunger)}%</span></span>
                        </div>`;
                    });
                }

                familyContent.innerHTML = html;
            } else {
                familySection.style.display = 'none';
            }
        }

        function updateActions() {
            if (gameState.isInCombat) {
                renderCombatActions();
                return;
            }

            const actionPanel = document.getElementById('action-panel');
            actionPanel.innerHTML = '';

            const actions = [
                { emoji: 'üîç', text: 'Forage', action: 'forage', energyCost: 10,
                  tooltip: 'Search for food and resources in your current location' },
                { emoji: 'üåø', text: 'Gather', action: 'gather', energyCost: 10,
                  tooltip: 'Collect twigs and materials for building' },
                { emoji: 'üò¥', text: 'Rest', action: 'rest', energyCost: 0,
                  tooltip: 'Recover energy and hunger slowly increases' },
                { emoji: 'üçñ', text: 'Eat', action: 'eat', disabled: gameState.food < 1,
                  tooltip: 'Consume food to reduce hunger and restore health' },
                { emoji: 'üë•', text: 'Socialize', action: 'socialize', energyCost: 5,
                  tooltip: 'Interact with other birds to increase social standing' }
            ];

            // Conditional actions
            if (!gameState.hasNest && !gameState.hasBirdhouse) {
                actions.push({ emoji: 'üèóÔ∏è', text: 'Build Nest', action: 'buildNest', energyCost: 15, disabled: gameState.twigs < 1,
                  tooltip: 'Construct a basic nest using twigs (requires 1+ twigs)' });
                if (gameState.twigs >= 15) {
                    actions.push({ emoji: 'üè†', text: 'Build Birdhouse', action: 'buildBirdhouse', energyCost: 20, class: 'success',
                      tooltip: 'Build a superior birdhouse for better rest and protection (requires 15 twigs)' });
                }
            }

            // Rest at nest (recover energy when you have a home)
            if ((gameState.hasNest || gameState.hasBirdhouse) && gameState.energy < gameState.maxEnergy * 0.6) {
                actions.push({ emoji: 'üò¥', text: 'Rest at Nest', action: 'restAtNest', energyCost: 0, class: 'success',
                  tooltip: 'Rest in your nest for faster energy recovery' });
            }

            // Food caching (unlock after level 3 or in Fall)
            if (gameState.level >= 3 || gameState.season === 2) {
                actions.push({ emoji: 'üå∞', text: 'Cache Food', action: 'cacheFood', energyCost: 5, disabled: gameState.food < 1,
                  tooltip: 'Hide food in this location to retrieve later' });
                const localCache = gameState.foodCaches.find(c => c.location === gameState.currentLocation);
                if (localCache && localCache.amount > 0) {
                    actions.push({ emoji: 'üîì', text: 'Retrieve Cache', action: 'retrieveCache', energyCost: 5,
                      tooltip: `Recover cached food from this location (${localCache.amount} food)` });
                }
            }

            // Flock leadership (unlock after level 5 and social standing 70+)
            if (gameState.level >= 5 && gameState.socialStanding >= 70) {
                actions.push({ emoji: 'ü¶Ö', text: 'Recruit Bird', action: 'recruitBird', energyCost: 10,
                  tooltip: 'Recruit a bird to join your flock (requires high social standing)' });
            }

            // Mushroom Mode
            if (gameState.mushroomFound && !gameState.mushroomModeActive) {
                actions.push({ emoji: 'üçÑ', text: 'Eat Mushroom', action: 'eatMushroom', energyCost: 0, class: 'warning',
                  tooltip: 'Consume the strange mushroom... who knows what will happen?' });
            }

            // Wind Chimes (if at nest and have wind chimes)
            if (gameState.hasWindChimes && !gameState.windChimesInstalled && (gameState.hasNest || gameState.hasBirdhouse)) {
                actions.push({ emoji: 'üéê', text: 'Install Chimes', action: 'installWindChimes', energyCost: 10,
                  tooltip: 'Install wind chimes at your nest for ambient music and bonuses' });
            }

            // Pond interaction (if at Willow Pond - location 5)
            if (gameState.currentLocation === 5) {
                actions.push({ emoji: 'üê∏', text: 'Visit Pond', action: 'visitPond', energyCost: 5,
                  tooltip: 'Interact with the peaceful pond and its inhabitants' });
            }

            // Courtship & Family Actions
            // Court a mate (Spring/Summer, have nest, no mate yet, decent social standing)
            if (!gameState.hasMate && (gameState.season === 0 || gameState.season === 1) &&
                (gameState.hasNest || gameState.hasBirdhouse) && gameState.socialStanding >= 50) {
                actions.push({ emoji: 'üíï', text: 'Find Mate', action: 'courtMate', energyCost: 15, class: 'primary',
                  tooltip: 'Court a potential mate during breeding season' });
            }

            // Lay eggs (have mate, nest, Spring, no eggs currently)
            if (gameState.hasMate && (gameState.hasNest || gameState.hasBirdhouse) &&
                gameState.season === 0 && gameState.eggs === 0 && gameState.eggsLaid === 0) {
                actions.push({ emoji: 'ü•ö', text: 'Lay Eggs', action: 'layEggs', energyCost: 20, class: 'primary',
                  tooltip: 'Lay eggs with your mate (Spring only)' });
            }

            // Incubate eggs (have eggs, need to keep them warm)
            if (gameState.eggs > 0) {
                actions.push({ emoji: 'ü™∫', text: 'Incubate Eggs', action: 'incubateEggs', energyCost: 5,
                  tooltip: `Keep your eggs warm (${gameState.incubationTurns}/5 turns to hatch)` });
            }

            // Feed babies (have babies that need food)
            const hungryBabies = gameState.babies.filter(b => b.hunger > 50);
            if (hungryBabies.length > 0) {
                actions.push({ emoji: 'üçº', text: `Feed Babies (${hungryBabies.length})`, action: 'feedBabies',
                    energyCost: 10, disabled: gameState.food < hungryBabies.length, class: 'danger',
                    tooltip: `Feed your hungry babies (needs ${hungryBabies.length} food)` });
            }

            // Standard UI actions
            actions.push({ emoji: 'üìä', text: 'Character', action: 'character', energyCost: 0,
              tooltip: 'View your character stats, skills, and achievements' });
            actions.push({ emoji: 'üìñ', text: 'Diary', action: 'diary', energyCost: 0,
              tooltip: 'Read your adventure diary and past events' });

            actions.forEach(a => {
                const btn = document.createElement('button');
                btn.className = `action-btn ${a.class || ''}`;
                btn.disabled = a.disabled || (a.energyCost && gameState.energy < a.energyCost);

                // Add tooltip if available
                if (a.tooltip) {
                    btn.title = a.tooltip;
                }

                // Add disabled reason
                if (btn.disabled) {
                    if (a.disabled) {
                        btn.title = (a.tooltip ? a.tooltip + ' - ' : '') + 'Requirements not met';
                    } else if (a.energyCost && gameState.energy < a.energyCost) {
                        btn.title = (a.tooltip ? a.tooltip + ' - ' : '') + `Not enough energy (need ${a.energyCost})`;
                    }
                }

                btn.innerHTML = `
                    <div class="btn-emoji">${a.emoji}</div>
                    <div class="btn-text">${a.text}</div>
                    ${a.energyCost ? `<div class="btn-text" style="font-size: 6px; opacity: 0.9;">-${a.energyCost}‚ö°</div>` : ''}
                `;
                btn.onclick = () => performAction(a.action);
                actionPanel.appendChild(btn);
            });
        }

        function updateQuests() {
            const questPanel = document.getElementById('quest-panel');
            const questContent = document.getElementById('quest-content');

            if (gameState.activeQuests.length > 0) {
                questPanel.style.display = 'block';
                questContent.innerHTML = gameState.activeQuests.map(q => {
                    const progressPercent = Math.min(100, (q.progress / q.goal) * 100);
                    const progressColor = progressPercent >= 100 ? '#27ae60' : progressPercent >= 50 ? '#f39c12' : '#3498db';
                    return `
                        <div class="quest-item" style="margin: 0; padding: 1px; display: flex; align-items: center; gap: 2px; font-size: 5px;">
                            <span>${q.emoji}</span>
                            <div style="flex: 1; background: #555; border-radius: 1px; height: 3px; overflow: hidden;">
                                <div style="width: ${progressPercent}%; background: ${progressColor}; height: 100%;"></div>
                            </div>
                            <span style="font-size: 5px;">${q.progress}/${q.goal}</span>
                        </div>
                    `;
                }).join('');
            } else {
                questPanel.style.display = 'none';
            }
        }

        // ===== ACTIONS =====
        function performAction(action) {
            // Check if this is an action that counts toward the turn limit
            const nonCountingActions = ['character', 'diary', 'endTurn'];
            const countsAsAction = !nonCountingActions.includes(action);

            // Perform the action
            switch(action) {
                case 'forage':
                    forage();
                    break;
                case 'gather':
                    gather();
                    break;
                case 'buildNest':
                    buildNest();
                    break;
                case 'restAtNest':
                    restAtNest();
                    break;
                case 'buildBirdhouse':
                    buildBirdhouse();
                    break;
                case 'rest':
                    rest();
                    break;
                case 'eat':
                    eat();
                    break;
                case 'socialize':
                    socialize();
                    break;
                case 'cacheFood':
                    cacheFood();
                    break;
                case 'retrieveCache':
                    retrieveCache();
                    break;
                case 'recruitBird':
                    recruitBird();
                    break;
                case 'eatMushroom':
                    eatMushroom();
                    break;
                case 'installWindChimes':
                    installWindChimes();
                    break;
                case 'visitPond':
                    visitPond();
                    break;
                case 'courtMate':
                    courtMate();
                    break;
                case 'layEggs':
                    layEggs();
                    break;
                case 'incubateEggs':
                    incubateEggs();
                    break;
                case 'feedBabies':
                    feedBabies();
                    break;
                case 'character':
                    showCharacterSheet();
                    break;
                case 'diary':
                    showDiary();
                    break;
                case 'endTurn':
                    endTurn();
                    break;
            }

            // Track action and check for auto-end conditions
            if (countsAsAction) {
                gameState.actionsTakenThisTurn++;
                checkAutoEndTurn();
            }
        }

        // Check if turn should auto-end
        function checkAutoEndTurn() {
            // Prevent multiple auto-end timers
            if (gameState.turnEndPending) {
                return;
            }

            // Check energy threshold
            if (gameState.energy <= 20) {
                addMessage('‚ö° You\'re too exhausted to continue! Time to rest...', 'warning');
                gameState.turnEndPending = true;
                setTimeout(() => {
                    gameState.turnEndPending = false;
                    endTurn();
                }, 2000);
                return;
            }

            // Check action limit
            if (gameState.actionsTakenThisTurn >= gameState.maxActionsPerTurn) {
                addMessage(`üìä You've taken ${gameState.maxActionsPerTurn} actions! The day passes...`, 'info');
                gameState.turnEndPending = true;
                setTimeout(() => {
                    gameState.turnEndPending = false;
                    endTurn();
                }, 2000);
                return;
            }

            // Update UI to show remaining actions
            updateUI();
        }

        function moveToTerritory(locationId) {
            const distance = 1; // Adjacent only
            const energyCost = 15;

            if (gameState.energy < energyCost) {
                addMessage('Not enough energy to fly!', 'danger');
                return;
            }

            rollSkillCheck('Flying', 10, (success) => {
                if (success) {
                    gameState.currentLocation = locationId;
                    gameState.energy -= energyCost;
                    addMessage(`Flew to ${TERRITORIES[locationId].name} ${TERRITORIES[locationId].emoji}`, 'success');

                    // Check for random encounter
                    checkRandomEncounter();
                } else {
                    gameState.energy -= Math.floor(energyCost / 2);
                    addMessage('Failed to fly efficiently, wasted some energy', 'warning');
                }
                updateUI();
            }, { action: 'flying', destination: TERRITORIES[locationId].name });
        }

        function forage() {
            const weatherMods = getWeatherModifiers();
            const energyCost = 10 + Math.abs(weatherMods.energyCost);
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            const territory = gameState.territories[gameState.currentLocation];
            const baseDC = gameState.season === 3 ? 20 : 10; // Winter is harder

            // Time of day bonus - foraging is easier during the day
            const timeBonus = gameState.timeOfDay === 'day' ? -2 : 0;
            const dc = baseDC + Math.abs(weatherMods.forageDC) + timeBonus;

            rollSkillCheck('Foraging', dc, (success, roll) => {
                gameState.energy -= energyCost;

                if (roll >= 20) {
                    // Critical success
                    const found = 5;
                    gameState.food += found;
                    addMessage(`üåü Amazing foraging! Found ${found} food!`, 'success');
                    gainXP(20);
                } else if (success) {
                    const found = Math.floor(Math.random() * 2) + 2;
                    gameState.food += found;
                    addMessage(`Found ${found} food üå∞`, 'success');
                    gainXP(10);
                } else if (roll === 1) {
                    addMessage('üí• Critical failure! A predator spotted you!', 'danger');
                    spawnPredator();
                } else {
                    const found = 1;
                    gameState.food += found;
                    addMessage(`Only found ${found} food`, 'info');
                    gainXP(5);
                }

                // Rare mushroom finding (3% chance)
                if (!gameState.mushroomFound && Math.random() < 0.03) {
                    gameState.mushroomFound = true;
                    addMessage('üçÑ‚ú® You found a MAGIC MUSHROOM! Something strange glows about it...', 'success');
                    addDiaryEntry('Discovered a mysterious glowing mushroom üçÑ', 'special');
                    gainXP(50);
                }

                // Random beneficial events (15% chance)
                const eventRoll = Math.random();
                if (eventRoll < 0.05) {
                    // Meet a friendly bird who teaches you something
                    const skillToBoost = ['foraging', 'perception', 'flocking'][Math.floor(Math.random() * 3)];
                    gameState.skills[skillToBoost]++;
                    addMessage(`üê¶ You meet a friendly ${gameState.species} who shares wisdom about ${skillToBoost}! +1 skill`, 'success');
                    gameState.socialStanding = Math.min(100, gameState.socialStanding + 5);
                    gainXP(25);
                } else if (eventRoll < 0.10) {
                    // Find extra twigs
                    const twigs = Math.floor(Math.random() * 2) + 1;
                    gameState.twigs += twigs;
                    addMessage(`üåø Lucky find! You discovered ${twigs} perfect ${twigs === 1 ? 'twig' : 'twigs'} while foraging!`, 'success');
                } else if (eventRoll < 0.15 && gameState.level >= 3) {
                    // Find a shiny object
                    gameState.socialStanding = Math.min(100, gameState.socialStanding + 10);
                    addMessage('‚ú® You found a shiny object! Other birds are impressed by your treasure', 'success');
                    gainXP(15);
                }

                gameState.hunger += 5;
                updateQuestProgress('forage', 1);
                updateUI();
            }, { action: 'foraging' });
        }

        function gather() {
            const energyCost = 10;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            rollSkillCheck('Building', 12, (success, roll) => {
                gameState.energy -= energyCost;

                if (roll >= 20) {
                    const found = 3;
                    gameState.twigs += found;
                    addMessage(`üåü Perfect gathering! Found ${found} twigs!`, 'success');
                    gainXP(15);
                } else if (success) {
                    const found = Math.floor(Math.random() * 2) + 1;
                    gameState.twigs += found;
                    addMessage(`Gathered ${found} twigs üåø`, 'success');
                    gainXP(10);
                } else {
                    addMessage('Failed to find good materials', 'warning');
                    gainXP(2);
                }

                gameState.hunger += 5;
                updateQuestProgress('gather', 1);
                updateUI();
            }, { action: 'gathering' });
        }

        function buildNest() {
            const energyCost = 15;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            if (gameState.twigs < 1) {
                addMessage('Need at least 1 twig to work on nest!', 'danger');
                return;
            }

            rollSkillCheck('Building', 12, (success, roll) => {
                gameState.energy -= energyCost;

                if (success) {
                    const twigsUsed = Math.min(gameState.twigs, 2);
                    gameState.twigs -= twigsUsed;
                    gameState.nestProgress += twigsUsed;

                    if (gameState.nestProgress >= 10 && !gameState.hasNest) {
                        gameState.hasNest = true;
                        addMessage('üéâ Nest completed! You now have a home!', 'success');
                        addDiaryEntry('Built my first nest! I finally have a home üè†', 'milestone');
                        gainXP(100);
                        completeQuest('firstHome');
                    } else {
                        addMessage(`Built nest (${gameState.nestProgress}/10 progress) üèóÔ∏è`, 'success');
                        gainXP(20);
                    }
                } else {
                    gameState.twigs -= 1;
                    gameState.nestProgress += 1;
                    addMessage(`Struggled with building (${gameState.nestProgress}/10)`, 'warning');
                    gainXP(5);
                }

                gameState.hunger += 5;
                updateUI();
            }, { action: 'building' });
        }

        function rest() {
            const energyGain = gameState.timeOfDay === 'night' ? 50 : 30;
            gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + energyGain);
            gameState.hunger += 10;

            if (gameState.timeOfDay === 'night' && Math.random() < 0.2) {
                addMessage('üò¥ Slept through the night peacefully...', 'success');
                endTurn();
            } else {
                addMessage(`Rested and regained ${energyGain} energy ‚ö°`, 'success');
            }

            updateUI();
        }

        function restAtNest() {
            // Better recovery when resting at your cozy home
            const baseRecovery = 35;
            const bonusFromMate = gameState.hasMate ? 10 : 0;
            const energyGain = baseRecovery + bonusFromMate;

            gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + energyGain);
            gameState.health = Math.min(gameState.maxHealth, gameState.health + 5);
            gameState.hunger += 3; // Less hunger than regular rest since you're safe

            const messages = [
                'üò¥ You nestle into your cozy home and feel refreshed',
                'üè† Safe in your nest, you recover your strength',
                'üí§ A peaceful rest in your sanctuary restores you'
            ];

            if (gameState.hasMate) {
                messages.push('üíï Your mate keeps you warm and safe while you rest');
            }

            const message = messages[Math.floor(Math.random() * messages.length)];
            addMessage(`${message} (+${energyGain} energy, +5 health)`, 'success');
            gainXP(5);

            updateUI();
        }

        function eat() {
            if (gameState.food < 1) {
                addMessage('Your crop is empty! No food to eat!', 'danger');
                return;
            }

            const foodEaten = Math.min(gameState.food, 3);
            gameState.food -= foodEaten;
            gameState.hunger = Math.max(0, gameState.hunger - foodEaten * 20);

            const eatMessages = [
                `You crack seeds with your beak and feel satisfied`,
                `Delicious! You gulp down ${foodEaten === 1 ? 'a plump worm' : 'some juicy insects'}`,
                `You peck through ${foodEaten === 1 ? 'a berry' : 'your stored food'}, filling your crop`,
                `Mmm! ${foodEaten === 1 ? 'That seed' : 'Those morsels'} hit the spot`
            ];
            const message = eatMessages[Math.floor(Math.random() * eatMessages.length)];
            addMessage(`${message} (-${foodEaten} food) üçñ`, 'success');
            updateUI();
        }

        function socialize() {
            const energyCost = 5;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            const territory = gameState.territories[gameState.currentLocation];
            if (territory.npcs.length === 0) {
                addMessage('No other birds here to socialize with!', 'warning');
                return;
            }

            rollSkillCheck('Flocking', 12, (success) => {
                gameState.energy -= energyCost;

                if (success) {
                    const standingGain = Math.floor(Math.random() * 10) + 5;
                    gameState.socialStanding = Math.min(100, gameState.socialStanding + standingGain);
                    const socialMessages = [
                        `You preen feathers with ${territory.npcs[0].emoji} - a bonding ritual`,
                        `Chirping and singing with ${territory.npcs[0].emoji} strengthens flock bonds`,
                        `You and ${territory.npcs[0].emoji} share a lovely duet - others are impressed!`,
                        `${territory.npcs[0].emoji} teaches you a new call pattern - you're in the flock!`
                    ];
                    const message = socialMessages[Math.floor(Math.random() * socialMessages.length)];
                    addMessage(`${message} +${standingGain} reputation üéµ`, 'success');
                    gainXP(15);

                    // Chance to find mate in spring
                    if (gameState.season === 0 && !gameState.hasMate && Math.random() < 0.3) {
                        gameState.hasMate = true;
                        gameState.mateSpecies = territory.npcs[0].species;
                        addMessage('üíï You found a mate! After courting displays and singing, they accept you!', 'success');
                        addDiaryEntry('Found a mate! Love is in the air üíï', 'social');
                        gainXP(50);
                        completeQuest('perfectMatch');
                        updateQuestProgress('mate', 1);
                    }
                } else {
                    const failMessages = [
                        `${territory.npcs[0].emoji} seems unimpressed by your song...`,
                        `You accidentally intrude on ${territory.npcs[0].emoji}'s perch - ruffled feathers!`,
                        `Your call was off-key. ${territory.npcs[0].emoji} flies away...`
                    ];
                    const message = failMessages[Math.floor(Math.random() * failMessages.length)];
                    addMessage(message, 'warning');
                    gainXP(5);
                }

                gameState.hunger += 5;
                updateUI();
            }, { action: 'flocking' });
        }

        // ===== PHASE 2 ACTIONS =====

        function cacheFood() {
            const energyCost = 5;
            if (gameState.energy < energyCost || gameState.food < 1) {
                addMessage('Not enough resources to cache food!', 'danger');
                return;
            }

            const amount = Math.min(gameState.food, 5); // Cache up to 5 at once
            gameState.food -= amount;
            gameState.energy -= energyCost;

            // Find or create cache at current location
            let cache = gameState.foodCaches.find(c => c.location === gameState.currentLocation);
            if (cache) {
                cache.amount += amount;
                cache.turnsLeft = 20; // Refresh timer
            } else {
                gameState.foodCaches.push({
                    location: gameState.currentLocation,
                    amount: amount,
                    turnsLeft: 20
                });
            }

            gameState.cachedFood += amount;
            addMessage(`Cached ${amount} food at ${TERRITORIES[gameState.currentLocation].name} üå∞`, 'success');
            addDiaryEntry(`Cached ${amount} food for later`, 'event');
            gainXP(10);
            updateQuestProgress('cache', amount);
            updateUI();
        }

        function retrieveCache() {
            const energyCost = 5;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            const cache = gameState.foodCaches.find(c => c.location === gameState.currentLocation);
            if (!cache || cache.amount === 0) {
                addMessage('No cache found here!', 'warning');
                return;
            }

            const retrieved = cache.amount;
            gameState.food += retrieved;
            gameState.energy -= energyCost;
            gameState.cachedFood -= retrieved;

            // Remove empty cache
            gameState.foodCaches = gameState.foodCaches.filter(c => c.location !== gameState.currentLocation);

            addMessage(`Retrieved ${retrieved} cached food! üîì`, 'success');
            gainXP(5);
            updateUI();
        }

        function buildBirdhouse() {
            const energyCost = 20;
            const twigsNeeded = 15;

            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            if (gameState.twigs < twigsNeeded) {
                addMessage(`Need ${twigsNeeded} twigs for a birdhouse!`, 'danger');
                return;
            }

            rollSkillCheck('Building', 15, (success, roll) => {
                gameState.energy -= energyCost;

                if (success) {
                    gameState.twigs -= twigsNeeded;
                    gameState.hasBirdhouse = true;
                    gameState.nestType = 'birdhouse';
                    gameState.maxHealth += 10; // Bonus health for better shelter
                    gameState.health = Math.min(gameState.health + 10, gameState.maxHealth);

                    addMessage('üéâ Birdhouse completed! A magnificent home! üè†', 'success');
                    addDiaryEntry('Built a luxurious birdhouse! The envy of all birds üè†', 'milestone');
                    gainXP(200);
                    completeQuest('firstHome');
                } else {
                    gameState.twigs = Math.max(0, gameState.twigs - 5); // Still lose some materials, but not go negative
                    addMessage('Struggled with birdhouse construction...', 'warning');
                    gainXP(20);
                }

                gameState.hunger += 10;
                updateUI();
            }, { action: 'building' });
        }

        function recruitBird() {
            const energyCost = 10;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            if (gameState.flockMembers.length >= 5) {
                addMessage('Your flock is already at maximum size!', 'warning');
                return;
            }

            const territory = gameState.territories[gameState.currentLocation];
            if (territory.npcs.length === 0) {
                addMessage('No birds here to recruit!', 'warning');
                return;
            }

            rollSkillCheck('Flocking', 16, (success) => {
                gameState.energy -= energyCost;

                if (success) {
                    const npc = territory.npcs[0];
                    gameState.flockMembers.push({
                        species: npc.species,
                        emoji: npc.emoji,
                        skill: Math.floor(Math.random() * 3) + 1
                    });

                    // Remove from territory
                    territory.npcs.shift();

                    addMessage(`${npc.emoji} joined your flock! ü¶Ö`, 'success');
                    addDiaryEntry(`Recruited ${npc.species} to my flock`, 'social');
                    gameState.socialStanding = Math.min(100, gameState.socialStanding + 10);
                    gainXP(50);
                } else {
                    addMessage('Failed to convince the bird to join...', 'warning');
                    gameState.socialStanding = Math.max(0, gameState.socialStanding - 5);
                    gainXP(10);
                }

                gameState.hunger += 5;
                updateUI();
            }, { action: 'flocking' });
        }

        function eatMushroom() {
            if (!gameState.mushroomFound) {
                addMessage('You don\'t have a mushroom!', 'danger');
                return;
            }

            gameState.mushroomFound = false;
            gameState.mushroomModeActive = true;
            gameState.mushroomModeTurns = 8; // Lasts 8 turns

            addMessage('üçÑ‚ú® Reality becomes a kaleidoscope! MUSHROOM MODE ACTIVATED! ‚ú®üçÑ', 'success');
            addDiaryEntry('Consumed a magic mushroom... reality will never be the same üçÑ', 'special');

            // Temporary stat boost
            gameState.skills.perception = Math.min(10, gameState.skills.perception + 3);

            updateUI();
        }

        function installWindChimes() {
            const energyCost = 10;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            gameState.energy -= energyCost;
            gameState.windChimesInstalled = true;
            gameState.hasWindChimes = false; // Used up the item

            addMessage('üéê Wind chimes installed! You\'ll be alerted to approaching predators.', 'success');
            addDiaryEntry('Hung wind chimes on my home tree. The gentle tinkling soothes me üéê', 'event');
            gainXP(30);
            updateUI();
        }

        function visitPond() {
            const energyCost = 5;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            if (gameState.visitedPondThisTurn) {
                addMessage('You already visited the pond this turn!', 'warning');
                return;
            }

            gameState.energy -= energyCost;
            gameState.visitedPondThisTurn = true;

            // Frog encounter!
            const roll = Math.random();

            if (roll < 0.3) {
                // Make friends with frog
                gameState.frogFriendship = Math.min(100, gameState.frogFriendship + 10);
                const gift = Math.floor(Math.random() * 2) + 1;
                gameState.food += gift;
                addMessage(`üê∏ A friendly frog brings you ${gift} insects as a gift!`, 'success');

                if (gameState.frogFriendship >= 50 && gameState.frogFriendship < 60) {
                    addMessage('üê∏ The frog seems to really like you now!', 'success');
                    gainXP(25);
                }
            } else if (roll < 0.6) {
                // Bathe and restore energy
                const energyGain = 15;
                gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + energyGain);
                addMessage(`üíß You bathe in the cool pond water. Refreshing! +${energyGain} energy`, 'success');
                gameState.socialStanding = Math.min(100, gameState.socialStanding + 5);
            } else {
                // Find something in the water
                if (Math.random() < 0.7) {
                    gameState.food += 2;
                    addMessage('üíß You found 2 fish near the pond!', 'success');
                } else {
                    gameState.twigs += 1;
                    addMessage('üíß You found a nice twig floating in the pond.', 'success');
                }
            }

            gameState.hunger += 3;
            gainXP(10);
            updateUI();
        }

        // ===== MATING & OFFSPRING SYSTEM =====
        function courtMate() {
            const energyCost = 15;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            // Roll Flocking check to attract a mate
            rollSkillCheck('Flocking', 14, (success) => {
                gameState.energy -= energyCost;

                if (success) {
                    // Successfully attracted a mate!
                    const mateSpecies = Object.keys(BIRD_SPECIES)[Math.floor(Math.random() * 5)];
                    gameState.hasMate = true;
                    gameState.mateSpecies = mateSpecies;
                    gameState.mateRelationship = 75;
                    gameState.courtshipProgress = 3;

                    const mateEmoji = BIRD_SPECIES[mateSpecies].emoji;
                    addMessage(`üíï A beautiful ${mateSpecies} ${mateEmoji} has become your mate! Your bond is strong!`, 'success');
                    addDiaryEntry(`Found my life partner - a ${mateSpecies}! üíï`, 'milestone');
                    gameState.socialStanding = Math.min(100, gameState.socialStanding + 15);
                    gainXP(100);
                } else {
                    addMessage('Your courtship display didn\'t impress anyone this time... Try again!', 'warning');
                    gameState.socialStanding = Math.max(0, gameState.socialStanding - 5);
                    gainXP(10);
                }

                gameState.hunger += 10;
                updateUI();
            }, { action: 'flocking' });
        }

        function layEggs() {
            const energyCost = 20;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            if (!gameState.hasMate) {
                addMessage('You need a mate to lay eggs!', 'warning');
                return;
            }

            gameState.energy -= energyCost;

            // Lay 2-4 eggs
            const numEggs = Math.floor(Math.random() * 3) + 2; // 2-4 eggs
            gameState.eggs = numEggs;
            gameState.eggsLaid = numEggs;
            gameState.incubationTurns = 0;

            addMessage(`ü•ö You laid ${numEggs} beautiful eggs in your nest! They need incubation.`, 'success');
            addDiaryEntry(`Laid ${numEggs} eggs! The next generation begins... ü•ö`, 'milestone');
            gameState.hunger += 20;
            gainXP(75);
            updateUI();
        }

        function incubateEggs() {
            const energyCost = 5;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            gameState.energy -= energyCost;
            gameState.incubationTurns++;

            addMessage(`ü™∫ You sit on your ${gameState.eggs} egg${gameState.eggs > 1 ? 's' : ''}, keeping them warm... (${gameState.incubationTurns}/5 turns)`, 'info');

            // Eggs hatch after 5 turns of incubation
            if (gameState.incubationTurns >= 5) {
                hatchEggs();
            }

            gameState.hunger += 5;
            gainXP(5);
            updateUI();
        }

        function hatchEggs() {
            const numBabies = gameState.eggs;
            gameState.eggs = 0;
            gameState.incubationTurns = 0;

            const babyNames = ['Pip', 'Chirp', 'Tweet', 'Peep', 'Sunny', 'Fluffy', 'Feather', 'Sky'];

            for (let i = 0; i < numBabies; i++) {
                const babyName = babyNames[Math.floor(Math.random() * babyNames.length)];
                const babySpecies = Math.random() < 0.7 ? gameState.species : (gameState.mateSpecies || gameState.species);
                gameState.babies.push({
                    name: babyName,
                    species: babySpecies,
                    age: 0, // Turns old
                    stage: 'hatchling', // hatchling -> fledgling -> independent
                    hunger: 50 // 0-100
                });
            }

            addMessage(`üê£ Your eggs have hatched! ${numBabies} adorable ${numBabies > 1 ? 'hatchlings' : 'hatchling'} chirp for food!`, 'success');
            addDiaryEntry(`My babies hatched! ${numBabies} little miracles! üê£`, 'milestone');
            gameState.offspring += numBabies;
            gainXP(150);
            updateUI();
        }

        function feedBabies() {
            const energyCost = 10;
            if (gameState.energy < energyCost) {
                addMessage('Not enough energy!', 'danger');
                return;
            }

            const hungryBabies = gameState.babies.filter(b => b.hunger > 50);
            const foodNeeded = hungryBabies.length;

            if (gameState.food < foodNeeded) {
                addMessage(`You need ${foodNeeded} food to feed all hungry babies!`, 'danger');
                return;
            }

            gameState.energy -= energyCost;
            gameState.food -= foodNeeded;

            hungryBabies.forEach(baby => {
                baby.hunger = Math.max(0, baby.hunger - 60);
                addMessage(`üçº Fed ${baby.name} the ${baby.species}. They chirp happily!`, 'success');
            });

            gameState.hunger += 5;
            gainXP(20 * foodNeeded);
            updateQuestProgress('feed', 1);
            updateUI();
        }

        // Update baby growth each turn (called from endTurn)
        function updateBabies() {
            gameState.babies.forEach(baby => {
                baby.age++;
                baby.hunger = Math.min(100, baby.hunger + 10); // Babies get hungry fast!

                // Growth stages
                if (baby.stage === 'hatchling' && baby.age >= 3) {
                    baby.stage = 'fledgling';
                    addMessage(`üê¶ ${baby.name} is now a fledgling! Growing up fast!`, 'success');
                    addDiaryEntry(`${baby.name} learned to flap their wings today! üê¶`, 'family');
                }

                if (baby.stage === 'fledgling' && baby.age >= 7) {
                    baby.stage = 'independent';
                    gameState.offspring++;
                    addMessage(`üåü ${baby.name} has left the nest! They're independent now.`, 'success');
                    addDiaryEntry(`${baby.name} flew away to start their own life. Proud parent moment! üåü`, 'milestone');
                    gainXP(100);
                    updateQuestProgress('family', 1);
                    updateQuestProgress('offspring', 1);
                }

                // Babies can starve if hunger reaches 100
                if (baby.hunger >= 100) {
                    addMessage(`üíî ${baby.name} didn't survive due to starvation...`, 'danger');
                    addDiaryEntry(`Lost ${baby.name} to hunger... I failed as a parent. üíî`, 'tragedy');
                    gameState.babies = gameState.babies.filter(b => b !== baby);
                }
            });

            // Remove independent babies from active roster
            gameState.babies = gameState.babies.filter(b => b.stage !== 'independent');
        }

        // ===== DICE ROLLING =====
        function rollSkillCheck(skillName, dc, callback, context = {}) {
            const skill = skillName.toLowerCase();
            const skillLevel = gameState.skills[skill] || 0;
            const roll = Math.floor(Math.random() * 20) + 1;
            const total = roll + skillLevel;
            const success = total >= dc;

            showDiceRoll(roll, skillLevel, dc, success, skillName, context, () => {
                callback(success, roll, total);
            });
        }

        function getFlavorText(action, roll, success, context = {}) {
            const isCrit = roll === 20;
            const isFail = roll === 1;
            const seasonName = SEASONS[gameState.season];
            const location = TERRITORIES[gameState.currentLocation].name;

            const flavors = {
                foraging: {
                    critSuccess: [
                        `You spot a hidden cache of seeds beneath the ${location} foliage! üåü`,
                        `A gust of wind reveals a bounty of berries you hadn't noticed! üåü`,
                        `Your keen eyes spot a feast of insects swarming nearby! üåü`,
                        `You discover a mother lode of worms after the recent rain! üåü`
                    ],
                    success: [
                        `You peck around and find some tasty morsels.`,
                        `Your search through the ${location} yields food.`,
                        `You manage to snag a few seeds and berries.`,
                        `Some insects cross your path - dinner time!`
                    ],
                    fail: [
                        `You scratch around but find mostly dirt and disappointment.`,
                        `The ${location} seems picked clean today.`,
                        `Other birds must have gotten here first...`,
                        `You find something, but it's not edible.`
                    ],
                    critFail: [
                        `Your frantic searching attracts unwanted attention! üí•`,
                        `You disturb something dangerous while foraging! üí•`,
                        `A predator was watching you this whole time! üí•`
                    ]
                },
                gathering: {
                    critSuccess: [
                        `You find the perfect twigs - sturdy and just the right size! üåü`,
                        `A dead branch falls nearby, providing excellent materials! üåü`,
                        `You discover a nest-builder's paradise! üåü`
                    ],
                    success: [
                        `You gather some decent building materials.`,
                        `These twigs should work for your nest.`,
                        `You collect what you can carry.`
                    ],
                    fail: [
                        `The twigs here are too brittle and break easily.`,
                        `You can't find quality materials in the ${location}.`,
                        `Everything you find is the wrong size.`
                    ],
                    critFail: [
                        `A twig snaps back and hits you in the beak! Ow! üí•`,
                        `You get tangled in some brambles while gathering! üí•`
                    ]
                },
                building: {
                    critSuccess: [
                        `Your nest-building skills shine! This section is perfect! üåü`,
                        `You weave the twigs with masterful precision! üåü`,
                        `This is coming together beautifully! üåü`
                    ],
                    success: [
                        `You carefully add to your nest structure.`,
                        `Bit by bit, your home takes shape.`,
                        `Steady progress on your nest.`
                    ],
                    fail: [
                        `The twigs won't stay in place. Frustrating!`,
                        `You struggle to get the structure right.`,
                        `Some of your work comes loose.`
                    ],
                    critFail: [
                        `A strong gust scatters your work! üí•`,
                        `The section you just built collapses! üí•`
                    ]
                },
                flying: {
                    critSuccess: [
                        `You soar gracefully through the air! What a flight! üåü`,
                        `The wind carries you effortlessly to your destination! üåü`,
                        `Perfect takeoff, perfect landing! üåü`
                    ],
                    success: [
                        `You wing your way to your destination.`,
                        `A smooth flight brings you to ${context.destination || 'your destination'}.`,
                        `You navigate the airways with ease.`
                    ],
                    fail: [
                        `You struggle against the wind, wasting energy.`,
                        `Your flight path is clumsy and inefficient.`,
                        `Turbulence throws you off course.`
                    ],
                    critFail: [
                        `You crash-land awkwardly! üí•`,
                        `A sudden wind gust sends you tumbling! üí•`
                    ]
                },
                combat: {
                    critSuccess: [
                        `Your attack is devastating! A perfect strike! üåü`,
                        `You catch ${context.enemy || 'the enemy'} completely off-guard! üåü`,
                        `A fierce and accurate blow lands true! üåü`
                    ],
                    success: [
                        `Your talons find their mark!`,
                        `You land a solid hit on ${context.enemy || 'the enemy'}!`,
                        `Your beak strikes with precision!`
                    ],
                    fail: [
                        `${context.enemy || 'The enemy'} dodges your attack!`,
                        `You miss completely!`,
                        `Your strike goes wide!`
                    ],
                    critFail: [
                        `You lose your balance and stumble! üí•`,
                        `Your attack leaves you wide open! üí•`,
                        `You accidentally hurt yourself! üí•`
                    ]
                },
                flocking: {
                    critSuccess: [
                        `The other bird is charmed by your charisma! üåü`,
                        `You make an instant connection! üåü`,
                        `What a delightful conversation! üåü`
                    ],
                    success: [
                        `You share a pleasant exchange.`,
                        `The other bird seems to enjoy your company.`,
                        `You make a good impression.`
                    ],
                    fail: [
                        `The conversation falls flat.`,
                        `You seem to have said the wrong thing.`,
                        `Awkward silence fills the air.`
                    ],
                    critFail: [
                        `You've somehow offended the other bird! üí•`,
                        `Your attempt at small talk goes terribly wrong! üí•`
                    ]
                },
                perception: {
                    critSuccess: [
                        `Your sharp eyes catch every detail! üåü`,
                        `Nothing escapes your notice! üåü`,
                        `You spot something others would miss! üåü`
                    ],
                    success: [
                        `You observe your surroundings carefully.`,
                        `Your senses pick up useful information.`,
                        `You notice important details.`
                    ],
                    fail: [
                        `Everything seems like a blur.`,
                        `You fail to notice anything special.`,
                        `Your attention wanders.`
                    ],
                    critFail: [
                        `You were so focused on looking, you missed what was right in front of you! üí•`,
                        `A distraction pulls your attention away! üí•`
                    ]
                }
            };

            const actionType = action.toLowerCase();
            let category = 'success';

            if (isCrit) category = 'critSuccess';
            else if (isFail) category = 'critFail';
            else if (!success) category = 'fail';

            const pool = flavors[actionType]?.[category] || flavors.perception[category];
            return pool[Math.floor(Math.random() * pool.length)];
        }

        function showDiceRoll(roll, modifier, dc, success, skillName, context, callback) {
            const modal = document.getElementById('dice-modal');
            const display = document.getElementById('dice-display');
            const result = document.getElementById('dice-result');
            const title = document.getElementById('dice-title');

            title.textContent = `${skillName} Attempt (Difficulty: ${dc})`;
            modal.classList.add('active');

            // Animate dice roll
            let counter = 0;
            const rollInterval = setInterval(() => {
                display.textContent = 'üé≤';
                display.className = '';
                counter++;
                if (counter > 8) {
                    clearInterval(rollInterval);

                    // Show result
                    display.textContent = roll;

                    // Get flavor text
                    const flavorText = getFlavorText(skillName, roll, success, context);

                    if (roll === 20) {
                        display.classList.add('crit-success');
                        result.innerHTML = `<div style="color: #2ecc71; font-size: 24px;">üåü CRITICAL SUCCESS! üåü</div>
                            <div style="margin: 15px 0; padding: 10px; background: #f0f9f4; border-radius: 8px; font-style: italic; color: #333;">
                                "${flavorText}"
                            </div>
                            <div>Rolled: ${roll} + ${modifier} = ${roll + modifier}</div>
                            <div>Challenge: ${dc}</div>`;
                    } else if (roll === 1) {
                        display.classList.add('crit-fail');
                        result.innerHTML = `<div style="color: #e74c3c; font-size: 24px;">üí• CRITICAL FAILURE! üí•</div>
                            <div style="margin: 15px 0; padding: 10px; background: #ffe6e6; border-radius: 8px; font-style: italic; color: #333;">
                                "${flavorText}"
                            </div>
                            <div>Rolled: ${roll} + ${modifier} = ${roll + modifier}</div>
                            <div>Challenge: ${dc}</div>`;
                    } else {
                        result.innerHTML = `
                            <div style="color: ${success ? '#2ecc71' : '#e67e22'}; font-size: 20px;">
                                ${success ? '‚úÖ SUCCESS' : '‚ùå FAILURE'}
                            </div>
                            <div style="margin: 15px 0; padding: 10px; background: ${success ? '#f0f9f4' : '#fff4e6'}; border-radius: 8px; font-style: italic; color: #333;">
                                "${flavorText}"
                            </div>
                            <div>Rolled: ${roll} + ${modifier} (skill) = ${roll + modifier}</div>
                            <div>Challenge: ${dc}</div>
                        `;
                    }

                    // Store callback
                    window.currentDiceCallback = callback;
                }
            }, 100);
        }

        function closeDiceModal() {
            document.getElementById('dice-modal').classList.remove('active');
            if (window.currentDiceCallback) {
                window.currentDiceCallback();
                window.currentDiceCallback = null;
            }
        }

        // ===== COMBAT =====
        function spawnPredator(forceBoss = false) {
            // Check for Rat King trigger
            if (gameState.ratsDefeated >= 5 && !forceBoss) {
                spawnRatKing();
                return;
            }

            const predators = [
                { name: 'Rat', emoji: 'üêÄ', health: 30, attack: [10, 15], xp: 50, type: 'rat' },
                { name: 'Squirrel', emoji: 'üêøÔ∏è', health: 40, attack: [12, 18], xp: 60, type: 'normal' },
                { name: 'Owl', emoji: 'ü¶â', health: 60, attack: [25, 35], xp: 100, type: 'normal' },
                { name: 'Crow', emoji: 'üê¶‚Äç‚¨õ', health: 50, attack: [15, 20], xp: 80, type: 'normal' },
                { name: 'Hawk', emoji: 'ü¶Ö', health: 70, attack: [20, 30], xp: 120, type: 'boss' }
            ];

            // Weight by danger and level
            let predator;
            if (gameState.level <= 2) {
                predator = { ...predators[0] }; // Rat for low levels
            } else if (gameState.level >= 7 && Math.random() < 0.15) {
                predator = { ...predators[4] }; // Hawk for high levels (rare)
            } else if (gameState.level >= 5 && Math.random() < 0.25) {
                predator = { ...predators[3] }; // Crow
            } else if (Math.random() < 0.6) {
                predator = { ...predators[Math.floor(Math.random() * 2)] }; // Rat or Squirrel
            } else {
                predator = { ...predators[2] }; // Owl
            }

            gameState.isInCombat = true;
            gameState.combatEnemy = predator;

            const bossWarning = predator.type === 'boss' ? ' ‚ö†Ô∏è BOSS ENCOUNTER!' : '';
            addMessage(`‚ö†Ô∏è A ${predator.emoji} ${predator.name} appeared!${bossWarning}`, 'danger');
            updateUI();
        }

        function spawnRatKing() {
            const ratKing = {
                name: 'RAT KING',
                emoji: 'üëëüêÄ',
                health: 100,
                attack: [20, 30],
                xp: 250,
                type: 'boss',
                isRatKing: true
            };

            gameState.isInCombat = true;
            gameState.combatEnemy = ratKing;

            addMessage('üëëüêÄ THE RAT KING HAS ARRIVED! The ruler of all rats challenges you!', 'danger');
            addDiaryEntry('Faced the legendary RAT KING in battle! üëëüêÄ', 'combat');
            updateUI();
        }

        function renderCombatActions() {
            const actionPanel = document.getElementById('action-panel');
            const enemy = gameState.combatEnemy;

            actionPanel.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; font-size: 48px; margin: 20px 0;">
                    ${enemy.emoji}
                </div>
                <div style="grid-column: 1 / -1; text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                    ${enemy.name} - HP: ${enemy.health}
                </div>
            `;

            const combatActions = [
                { emoji: '‚öîÔ∏è', text: 'Attack', action: () => combatAttack() },
                { emoji: 'üõ°Ô∏è', text: 'Defend', action: () => combatDefend() },
                { emoji: 'üèÉ', text: 'Flee', action: () => combatFlee() }
            ];

            combatActions.forEach(a => {
                const btn = document.createElement('button');
                btn.className = 'action-btn danger';
                btn.innerHTML = `
                    <div class="btn-emoji">${a.emoji}</div>
                    <div class="btn-text">${a.text}</div>
                `;
                btn.onclick = a.action;
                actionPanel.appendChild(btn);
            });
        }

        function combatAttack() {
            const enemy = gameState.combatEnemy;
            rollSkillCheck('Combat', 15, (success, roll) => {
                if (success) {
                    const damage = Math.floor(Math.random() * 15) + 10 + gameState.skills.combat * 2;
                    enemy.health -= damage;
                    addMessage(`You dealt ${damage} damage to the ${enemy.name}! ‚öîÔ∏è`, 'success');

                    if (enemy.health <= 0) {
                        winCombat();
                        return;
                    }
                } else {
                    addMessage('Your attack missed!', 'warning');
                }

                // Enemy attacks back
                enemyAttack();
            }, { action: 'combat', enemy: enemy.name });
        }

        function combatDefend() {
            const enemy = gameState.combatEnemy;
            rollSkillCheck('Combat', 12, (success) => {
                if (success) {
                    addMessage('You brace for the attack! üõ°Ô∏è', 'success');
                    gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + 10);

                    // Enemy attack with reduced damage
                    enemyAttack(0.5);
                } else {
                    addMessage('Failed to defend properly!', 'warning');
                    enemyAttack();
                }
            }, { action: 'combat', enemy: enemy.name });
        }

        function combatFlee() {
            const enemy = gameState.combatEnemy;
            rollSkillCheck('Flying', 18, (success) => {
                if (success) {
                    addMessage('Successfully fled from combat! üèÉ', 'success');
                    gameState.isInCombat = false;
                    gameState.combatEnemy = null;
                    gameState.energy -= 20;
                    updateUI();
                } else {
                    addMessage('Failed to escape!', 'danger');
                    enemyAttack();
                }
            }, { action: 'flying', enemy: enemy.name });
        }

        function enemyAttack(damageMultiplier = 1) {
            const enemy = gameState.combatEnemy;
            const damage = Math.floor((Math.random() * (enemy.attack[1] - enemy.attack[0]) + enemy.attack[0]) * damageMultiplier);

            gameState.health -= damage;
            addMessage(`The ${enemy.name} attacks for ${damage} damage! üí•`, 'danger');

            if (gameState.health <= 0) {
                gameOver();
            } else {
                updateUI();
            }
        }

        function winCombat() {
            const enemy = gameState.combatEnemy;
            addMessage(`üéâ Defeated the ${enemy.name}!`, 'success');
            addDiaryEntry(`Defeated a ${enemy.name}! Proved my courage in battle`, 'combat');
            gainXP(enemy.xp);

            // Track rat defeats for Rat King trigger
            if (enemy.type === 'rat' || enemy.name === 'Rat') {
                gameState.ratsDefeated++;
                if (gameState.ratsDefeated === 5) {
                    addMessage('‚ö†Ô∏è You sense something ominous... The Rat King grows angry!', 'warning');
                }
            }

            // Boss rewards
            if (enemy.isRatKing) {
                addMessage('üëë You defeated the RAT KING! Legendary status achieved!', 'success');
                addDiaryEntry('DEFEATED THE LEGENDARY RAT KING! I am a true warrior! üëë', 'milestone');
                gameState.maxHealth = Math.min(200, gameState.maxHealth + 20); // Cap at 200
                gameState.health = gameState.maxHealth;
                gameState.socialStanding = Math.min(100, gameState.socialStanding + 30);
                gameState.food += 10; // Reward food
                gameState.ratsDefeated = 0; // Reset counter
            } else if (enemy.type === 'boss') {
                addMessage(`üíé Boss defeated! Major rewards earned!`, 'success');
                gameState.maxHealth = Math.min(200, gameState.maxHealth + 5); // Cap at 200
                gameState.health = Math.min(gameState.health + 20, gameState.maxHealth);
                gameState.food += 5;
            }

            gameState.isInCombat = false;
            gameState.combatEnemy = null;
            gameState.socialStanding = Math.min(100, gameState.socialStanding + 10);

            updateQuestProgress('combat', 1);
            updateUI();
        }

        // ===== TURN & SEASON MANAGEMENT =====
        function endTurn() {
            // Reset action counter for new turn
            gameState.actionsTakenThisTurn = 0;
            gameState.visitedPondThisTurn = false; // Reset pond visit flag

            // Passive effects
            gameState.hunger += 5;

            // Daily recovery bonuses from home comforts
            if (gameState.hasNest || gameState.hasBirdhouse) {
                gameState.health = Math.min(gameState.maxHealth, gameState.health + 3);
                addMessage('üè† Your cozy nest helps you recover health', 'success');
            }
            if (gameState.hasMate) {
                gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + 5);
                addMessage('üíï Your mate\'s companionship restores energy', 'success');
            }
            if ((gameState.hasNest || gameState.hasBirdhouse) && gameState.hasMate) {
                gameState.socialStanding = Math.min(100, gameState.socialStanding + 1);
            }

            // Mushroom Mode effects
            if (gameState.mushroomModeActive) {
                gameState.mushroomModeTurns--;
                gameState.hunger += 10; // Extra hunger during mushroom mode
                addMessage(`üçÑ Mushroom Mode: Reality swirls... ${gameState.mushroomModeTurns} turns left`, 'warning');

                if (gameState.mushroomModeTurns <= 0) {
                    gameState.mushroomModeActive = false;
                    gameState.skills.perception = Math.max(1, gameState.skills.perception - 3); // Remove temp boost
                    addMessage('üçÑ Mushroom Mode ended. Reality returns to normal...', 'info');
                    addDiaryEntry('The psychedelic visions faded... what a trip! üçÑ', 'event');
                }
            }

            if (gameState.hunger >= 100) {
                gameState.health -= 10;
                addMessage('‚ö†Ô∏è Starving! Losing health!', 'danger');
            }

            // Update babies (hunger, growth, leaving nest)
            if (gameState.babies.length > 0) {
                updateBabies();
            }

            // Food cache decay
            gameState.foodCaches.forEach(cache => {
                cache.turnsLeft--;
                if (cache.turnsLeft <= 0) {
                    addMessage(`‚ö†Ô∏è Your cache at ${TERRITORIES[cache.location].name} has spoiled!`, 'warning');
                    gameState.cachedFood = Math.max(0, gameState.cachedFood - cache.amount);
                }
            });
            gameState.foodCaches = gameState.foodCaches.filter(c => c.turnsLeft > 0);

            // Advance time
            gameState.turn++;
            gameState.timeOfDay = gameState.timeOfDay === 'day' ? 'night' : 'day';

            // Seasonal deadline warnings with bird-life flavor
            const turnsUntilSeasonEnd = TURNS_PER_SEASON - gameState.turn;
            if (turnsUntilSeasonEnd === 5) {
                const warnings = {
                    0: 'üå∏ Spring is ending soon! Have you found a mate and built your nest?',
                    1: '‚òÄÔ∏è Summer wanes... Are your young ready to fly? Have you gathered enough?',
                    2: 'üçÇ The autumn leaves are falling! Winter approaches - is your cache full?',
                    3: '‚ùÑÔ∏è The cold deepens... Only the prepared survive the harshest days ahead.'
                };
                addMessage(warnings[gameState.season], 'warning');
            }

            if (gameState.season === 0 && turnsUntilSeasonEnd === 3 && !gameState.hasMate) {
                addMessage('üíï Mating season is almost over! Find a partner before summer!', 'danger');
            }

            if (gameState.season === 2 && turnsUntilSeasonEnd === 3 && gameState.cachedFood < 10) {
                addMessage('‚ö†Ô∏è Winter is nearly here and your cache is dangerously low!', 'danger');
            }

            // Update weather periodically (every 3 turns)
            if (gameState.turn % 3 === 0) {
                updateWeather();
            }

            // UFO Encounter (5% chance at night, only if not recently encountered)
            const turnsSinceLastUFO = gameState.turn - gameState.lastUFOTurn;
            if (gameState.timeOfDay === 'night' && turnsSinceLastUFO > 30 && Math.random() < 0.05) {
                triggerUFOEncounter();
            }

            // Random events
            if (Math.random() < 0.1) {
                checkRandomEncounter();
            }

            // End of season
            if (gameState.turn > TURNS_PER_SEASON) {
                advanceSeason();
            }

            // Check game over
            if (gameState.health <= 0) {
                gameOver();
            } else {
                addMessage(`Turn ${gameState.turn} begins...`, 'info');
                updateUI();
            }
        }

        // ===== UFO ENCOUNTER =====
        function triggerUFOEncounter() {
            gameState.lastUFOTurn = gameState.turn;
            gameState.ufoEncounterHappened = true;

            const outcomes = [
                {
                    name: 'abduction',
                    message: 'üõ∏ A UFO APPEARS! Bright lights surround you... You wake up 3 turns later with strange marks! üëΩ',
                    effect: () => {
                        // Skip 3 turns but gain bonus XP
                        gameState.turn += 3;
                        gainXP(100);
                        addMessage('‚ú® You gained cosmic knowledge! +100 XP', 'success');
                    }
                },
                {
                    name: 'gift',
                    message: 'üõ∏ A UFO hovers overhead and drops a GLOWING STAR SEED! üåü',
                    effect: () => {
                        gameState.food += 5;
                        gameState.energy = gameState.maxEnergy;
                        addMessage('The star seed fills you with cosmic energy!', 'success');
                    }
                },
                {
                    name: 'savior',
                    message: 'üõ∏ A UFO beams up the predator that was stalking you! You\'re saved!',
                    effect: () => {
                        // Prevent next predator encounter
                        gameState.socialStanding = Math.min(100, gameState.socialStanding + 15);
                    }
                }
            ];

            const outcome = outcomes[Math.floor(Math.random() * outcomes.length)];
            addMessage(outcome.message, 'success');
            addDiaryEntry(`UFO encounter! ${outcome.message}`, 'special');
            outcome.effect();
        }

        function advanceSeason() {
            // Check survival quests before advancing (end of winter)
            if (gameState.season === 3) {
                gameState.activeQuests.forEach(quest => {
                    if (quest.type === 'survive') {
                        if (gameState.health >= quest.goal) {
                            completeQuest(quest.id);
                        }
                    }
                });
            }

            gameState.season++;
            gameState.turn = 1;

            if (gameState.season >= 4) {
                gameState.season = 0;
                gameState.year++;
                addMessage(`üéä Year ${gameState.year} begins! You made it through winter!`, 'success');
                addDiaryEntry(`Survived another year! Now in year ${gameState.year} üéä`, 'milestone');

                // Reset breeding cycle for new year
                gameState.eggsLaid = 0;

                // Yearly bonuses
                if (gameState.hasNest && gameState.hasMate) {
                    const newEggs = Math.floor(Math.random() * 3) + 2;
                    gameState.eggs = newEggs;
                    addMessage(`ü•ö Your mate laid ${newEggs} eggs for the new breeding season!`, 'success');
                    addDiaryEntry(`My mate laid ${newEggs} eggs! Starting a family ü•ö`, 'social');
                    gainXP(100);
                }
            }

            const seasonName = SEASONS[gameState.season];
            const seasonMessages = {
                0: `${SEASON_EMOJIS[seasonName]} ${seasonName} has arrived! The air warms, flowers bloom - time to nest and find a mate!`,
                1: `${SEASON_EMOJIS[seasonName]} ${seasonName} has arrived! Food is plentiful, but so are predators drawn by nestlings.`,
                2: `${SEASON_EMOJIS[seasonName]} ${seasonName} has arrived! Leaves turn gold - prepare now or face winter's wrath!`,
                3: `${SEASON_EMOJIS[seasonName]} ${seasonName} has arrived! The cold sets in. Survival is all that matters now.`
            };
            addMessage(seasonMessages[gameState.season], 'success');
            addDiaryEntry(`${seasonName} has arrived`, 'event');

            // Add seasonal quest
            addSeasonalQuest();

            updateUI();
        }

        // ===== QUEST SYSTEM =====
        const ALL_QUESTS = {
            // SPRING QUESTS - Focus on nest building, courtship, and territory
            'firstHome': { name: 'Build Your First Home', emoji: 'üè†', desc: 'Establish your nest before eggs arrive - a safe shelter is essential for raising young', type: 'build', goal: 1, reward: 100, season: 0 },
            'perfectMatch': { name: 'Find Your Perfect Match', emoji: 'üíï', desc: 'Spring is mating season! Find a partner to share your nest and raise a family', type: 'mate', goal: 1, reward: 150, season: 0 },
            'territorialVictor': { name: 'Defend Your Territory', emoji: '‚öîÔ∏è', desc: 'Establish dominance by driving away 3 intruders from your nesting grounds', type: 'combat', goal: 3, reward: 200, season: 0 },
            'springGatherer': { name: 'Spring Gatherer', emoji: 'üåø', desc: 'Collect 15 twigs while they\'re plentiful - you\'ll need them for nest repairs', type: 'gather', goal: 15, reward: 75, season: 0 },
            'socialButterfly': { name: 'Social Butterfly', emoji: 'ü¶ã', desc: 'Build your reputation in the flock - reach 70 social standing to attract a quality mate', type: 'social', goal: 70, reward: 100, season: 0 },
            'nestingDeadline': { name: 'The Nesting Deadline', emoji: '‚è∞', desc: 'URGENT: Build a nest before spring ends or lose the entire breeding season!', type: 'build', goal: 1, reward: 200, season: 0 },

            // SUMMER QUESTS - Focus on raising young, gathering food, protection
            'provider': { name: 'The Provider', emoji: 'üçñ', desc: 'Gather 25 food - your hungry chicks need constant feeding to survive', type: 'forage', goal: 25, reward: 150, season: 1 },
            'guardianNest': { name: 'Guardian of the Nest', emoji: 'üõ°Ô∏è', desc: 'Predators are drawn to baby birds - defend your nest from danger', type: 'defend', goal: 1, reward: 200, season: 1 },
            'raisingYoung': { name: 'Raising the Young', emoji: 'üê£', desc: 'The most important job - raise 2 babies to fledgling stage before fall', type: 'family', goal: 2, reward: 250, season: 1 },
            'explorerSpring': { name: 'Summer Explorer', emoji: 'üó∫Ô∏è', desc: 'Scout all 9 territories to find the best feeding grounds for your family', type: 'explore', goal: 9, reward: 175, season: 1 },
            'ratHunter': { name: 'Rat Hunter', emoji: 'üêÄ', desc: 'Defeat 5 rats - these nest raiders threaten eggs and helpless chicks', type: 'combat', goal: 5, reward: 300, season: 1 },
            'feedingFrenzy': { name: 'Feeding Frenzy', emoji: 'üêõ', desc: 'Feed your babies 10 times - constant feeding is exhausting but necessary', type: 'feed', goal: 10, reward: 175, season: 1 },

            // FALL QUESTS - Focus on preparation, caching, fortification
            'winterPrep': { name: 'Winter Preparation', emoji: 'üå∞', desc: 'CRITICAL: Cache 20 food items - winter starvation is the #1 killer', type: 'cache', goal: 20, reward: 200, season: 2 },
            'fortification': { name: 'Fortify Your Home', emoji: 'üè∞', desc: 'Upgrade to a birdhouse - better insulation means survival through harsh storms', type: 'upgrade', goal: 1, reward: 250, season: 2 },
            'alliance': { name: 'Form an Alliance', emoji: 'ü§ù', desc: 'Recruit 3 birds - flocks share warmth and spot predators more easily in winter', type: 'flock', goal: 3, reward: 175, season: 2 },
            'autumnHarvest': { name: 'Autumn Harvest', emoji: 'üçÇ', desc: 'Forage 30 food NOW while it\'s still plentiful - winter offers little', type: 'forage', goal: 30, reward: 150, season: 2 },
            'skillMaster': { name: 'Skill Mastery', emoji: '‚≠ê', desc: 'Reach level 5 - experienced birds survive winter better', type: 'level', goal: 5, reward: 300, season: 2 },
            'lastChance': { name: 'Last Chance Cache', emoji: '‚è∞', desc: 'URGENT: Store at least 15 food before the first frost - your life depends on it!', type: 'cache', goal: 15, reward: 250, season: 2 },

            // WINTER QUESTS - Focus on survival, conservation, community
            'survivor': { name: 'The Survivor', emoji: '‚ùÑÔ∏è', desc: 'Many birds perish in winter - keep your health above 50 to see spring again', type: 'survive', goal: 50, reward: 250, season: 3 },
            'winterWarrior': { name: 'Winter Warrior', emoji: '‚öîÔ∏è', desc: 'Desperate birds will raid your cache - defend it 3 times or starve', type: 'defend', goal: 3, reward: 200, season: 3 },
            'fortress': { name: 'Weather the Storm', emoji: 'üå®Ô∏è', desc: 'Blizzards are deadly - survive 3 storms by hunkering down safely', type: 'weather', goal: 3, reward: 150, season: 3 },
            'sharingSoul': { name: 'Sharing Soul', emoji: 'üíù', desc: 'Share food with struggling flock members 5 times - generosity builds bonds', type: 'share', goal: 5, reward: 175, season: 3 },
            'bossSlayer': { name: 'Boss Slayer', emoji: 'üëë', desc: 'Hungry predators are more aggressive in winter - defeat a boss to prove your strength', type: 'boss', goal: 1, reward: 500, season: 3 },
            'endurance': { name: 'Endurance Test', emoji: 'üí™', desc: 'Make it through winter without your health dropping below 30 - the ultimate challenge', type: 'survive', goal: 30, reward: 300, season: 3 },

            // YEAR-ROUND QUESTS
            'legacy': { name: 'Build a Legacy', emoji: 'üåü', desc: 'Raise 6 offspring to independence', type: 'offspring', goal: 6, reward: 600, season: -1 },
            'apexBird': { name: 'Apex Bird', emoji: 'ü¶Ö', desc: 'Reach level 10', type: 'level', goal: 10, reward: 1000, season: -1 },
            'dynastyBuilder': { name: 'Dynasty Builder', emoji: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', desc: 'Raise 10 total offspring', type: 'offspring', goal: 10, reward: 800, season: -1 },
        };

        function addSeasonalQuest() {
            // Find quests for current season
            const availableQuests = Object.entries(ALL_QUESTS)
                .filter(([id, quest]) => quest.season === gameState.season || quest.season === -1)
                .filter(([id, quest]) => !gameState.completedQuests.includes(id))
                .filter(([id, quest]) => !gameState.activeQuests.find(q => q.id === id));

            // Add 1-2 quests per season
            const numQuestsToAdd = Math.min(2, availableQuests.length);
            for (let i = 0; i < numQuestsToAdd; i++) {
                if (availableQuests[i]) {
                    const [id, questData] = availableQuests[i];
                    const quest = { ...questData, id, progress: 0 };

                    // Set initial progress for some quest types
                    if (quest.type === 'build' && gameState.hasNest) quest.progress = 1;
                    if (quest.type === 'mate' && gameState.hasMate) quest.progress = 1;
                    if (quest.type === 'cache') quest.progress = gameState.cachedFood;
                    if (quest.type === 'social') quest.progress = gameState.socialStanding;
                    if (quest.type === 'level') quest.progress = gameState.level;
                    if (quest.type === 'offspring') quest.progress = gameState.offspring;

                    gameState.activeQuests.push(quest);
                    addMessage(`üìú New Quest: ${quest.emoji} ${quest.name}!`, 'info');
                    addMessage(`   ${quest.desc}`, 'info');
                }
            }
        }

        function updateQuestProgress(type, amount) {
            gameState.activeQuests.forEach(quest => {
                if (quest.type === type) {
                    quest.progress += amount;
                    if (quest.progress >= quest.goal) {
                        completeQuest(quest.id);
                    }
                }
            });
        }

        function completeQuest(questId) {
            const questIndex = gameState.activeQuests.findIndex(q => q.id === questId);
            if (questIndex !== -1) {
                const quest = gameState.activeQuests[questIndex];
                addMessage(`üéâ Quest Complete: ${quest.emoji} ${quest.name}!`, 'success');
                addMessage(`   Reward: +${quest.reward} XP!`, 'success');
                addDiaryEntry(`Completed quest: ${quest.name}! ${quest.desc}`, 'achievement');
                gainXP(quest.reward);
                gameState.completedQuests.push(questId); // Just push the ID
                gameState.activeQuests.splice(questIndex, 1);

                // Check if we should add a new quest
                addSeasonalQuest();
            }
        }

        // ===== PROGRESSION =====
        function gainXP(amount) {
            gameState.xp += amount;
            addMessage(`+${amount} XP`, 'info');

            while (gameState.xp >= gameState.xpNeeded && gameState.level < 10) {
                levelUp();
            }
        }

        function levelUp() {
            gameState.level++;
            gameState.xp -= gameState.xpNeeded;
            gameState.xpNeeded = Math.floor(gameState.xpNeeded * 1.5);
            gameState.maxHealth += 10;
            gameState.health = gameState.maxHealth;
            gameState.maxEnergy += 5;
            gameState.energy = gameState.maxEnergy;

            addMessage(`üåü LEVEL UP! Now level ${gameState.level}!`, 'success');
            addDiaryEntry(`Reached level ${gameState.level}! Growing stronger üåü`, 'milestone');

            // Let player choose skill to increase
            showSkillChoice();
        }

        function showSkillChoice() {
            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            const buttons = document.getElementById('modal-buttons');

            title.textContent = 'üåü Choose a Skill to Improve!';
            body.innerHTML = '<div style="margin: 15px 0;">Select one skill to increase by 1:</div>';

            buttons.innerHTML = '';
            Object.keys(gameState.skills).forEach(skill => {
                const btn = document.createElement('button');
                btn.className = 'modal-btn primary';
                btn.textContent = `${skill.charAt(0).toUpperCase() + skill.slice(1)} (${gameState.skills[skill]} ‚Üí ${gameState.skills[skill] + 1})`;
                btn.style.margin = '5px';
                btn.onclick = () => {
                    gameState.skills[skill]++;
                    modal.classList.remove('active');
                    addMessage(`${skill.charAt(0).toUpperCase() + skill.slice(1)} increased to ${gameState.skills[skill]}!`, 'success');
                    updateUI();
                };
                buttons.appendChild(btn);
            });

            modal.classList.add('active');
        }

        // ===== RANDOM EVENTS =====
        function checkRandomEncounter() {
            const roll = Math.random();

            if (roll < 0.15) {
                spawnPredator();
            } else if (roll < 0.3) {
                // Find bonus resources
                const bonus = Math.floor(Math.random() * 3) + 1;
                gameState.food += bonus;
                addMessage(`üçÄ Found ${bonus} bonus food!`, 'success');
            } else if (roll < 0.4) {
                // Weather event
                const events = ['A storm approaches...', 'The sun shines warmly', 'Wind picks up'];
                addMessage(`üå§Ô∏è ${events[Math.floor(Math.random() * events.length)]}`, 'info');
            }
        }

        // ===== CHARACTER SHEET =====
        function showCharacterSheet() {
            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            const buttons = document.getElementById('modal-buttons');

            title.textContent = 'üìä Character Sheet';
            body.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px;">üê¶</div>
                    <div style="font-size: 20px; font-weight: bold;">Level ${gameState.level} ${gameState.species}</div>
                    <div style="font-size: 14px; color: #666;">Year ${gameState.year} | ${gameState.offspring} Offspring</div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0;">
                    <div class="skill-item"><span>üîç Foraging</span><span class="skill-level">${gameState.skills.foraging}</span></div>
                    <div class="skill-item"><span>üèóÔ∏è Building</span><span class="skill-level">${gameState.skills.building}</span></div>
                    <div class="skill-item"><span>ü¶Ö Flying</span><span class="skill-level">${gameState.skills.flying}</span></div>
                    <div class="skill-item"><span>‚öîÔ∏è Combat</span><span class="skill-level">${gameState.skills.combat}</span></div>
                    <div class="skill-item"><span>üë• Flocking</span><span class="skill-level">${gameState.skills.flocking}</span></div>
                    <div class="skill-item"><span>üëÅÔ∏è Perception</span><span class="skill-level">${gameState.skills.perception}</span></div>
                </div>

                <div style="margin: 15px 0; padding: 10px; background: #f0f0f0; border-radius: 8px;">
                    <div><strong>Nest:</strong> ${gameState.hasNest ? '‚úÖ Built' : `üèóÔ∏è ${gameState.nestProgress}/10`}</div>
                    <div><strong>Mate:</strong> ${gameState.hasMate ? 'üíï Yes' : '‚ùå No'}</div>
                    <div><strong>Completed Quests:</strong> ${gameState.completedQuests.length}</div>
                </div>

                ${gameState.activeQuests.length > 0 ? `
                    <div style="margin: 15px 0; padding: 10px; background: #fff3cd; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 10px;">üìú Active Quests</div>
                        ${gameState.activeQuests.map(q => {
                            const progressPercent = Math.min(100, (q.progress / q.goal) * 100);
                            const progressColor = progressPercent >= 100 ? '#27ae60' : progressPercent >= 50 ? '#f39c12' : '#3498db';
                            return `
                                <div style="margin: 10px 0; padding: 8px; background: white; border-radius: 5px;">
                                    <div style="font-weight: bold; margin-bottom: 5px;">${q.emoji} ${q.name}</div>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${q.desc}</div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; background: #ddd; border-radius: 10px; height: 12px; overflow: hidden;">
                                            <div style="width: ${progressPercent}%; background: ${progressColor}; height: 100%;"></div>
                                        </div>
                                        <div style="font-size: 12px; font-weight: bold;">${q.progress}/${q.goal}</div>
                                    </div>
                                    <div style="font-size: 11px; color: #27ae60; margin-top: 3px;">Reward: ${q.reward} XP</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
            `;

            buttons.innerHTML = '<button class="modal-btn primary" onclick="closeModal()">Close</button>';
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('generic-modal').classList.remove('active');
        }

        // ===== DIARY SYSTEM =====
        function addDiaryEntry(text, type = 'event') {
            const entry = {
                turn: gameState.turn,
                season: SEASONS[gameState.season],
                year: gameState.year,
                text: text,
                type: type, // event, milestone, combat, social
                timestamp: Date.now()
            };
            gameState.diary.push(entry);

            // Keep last 50 entries
            if (gameState.diary.length > 50) {
                gameState.diary.shift();
            }
        }

        function showDiary() {
            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            const buttons = document.getElementById('modal-buttons');

            title.textContent = 'üìñ Life Story';

            if (gameState.diary.length === 0) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìù</div>
                        <p>Your story has just begun...<br/>Live your life and return to read your tale!</p>
                    </div>
                `;
            } else {
                const entries = gameState.diary.slice().reverse().map(entry => {
                    const icon = {
                        event: 'üìÖ',
                        milestone: '‚≠ê',
                        combat: '‚öîÔ∏è',
                        social: 'üí¨'
                    }[entry.type] || 'üìÖ';

                    const bgColor = {
                        event: '#f0f9ff',
                        milestone: '#fff9e6',
                        combat: '#ffe6e6',
                        social: '#f0f9f4'
                    }[entry.type] || '#f0f0f0';

                    return `
                        <div style="background: ${bgColor}; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #667eea;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                                ${icon} ${entry.season} Year ${entry.year}, Turn ${entry.turn}
                            </div>
                            <div style="font-size: 13px;">${entry.text}</div>
                        </div>
                    `;
                }).join('');

                body.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #666;">
                                Your journey through ${gameState.year} year(s) | ${gameState.diary.length} memories
                            </div>
                        </div>
                        ${entries}
                    </div>
                `;
            }

            // Add Copy Story button if there are diary entries
            if (gameState.diary.length > 0) {
                buttons.innerHTML = `
                    <button class="modal-btn success" onclick="copyStoryToClipboard()" style="background: #27ae60;">üìã Copy Story</button>
                    <button class="modal-btn primary" onclick="closeModal()">Close</button>
                `;
            } else {
                buttons.innerHTML = '<button class="modal-btn primary" onclick="closeModal()">Close</button>';
            }

            modal.classList.add('active');
        }

        function copyStoryToClipboard() {
            const storyText = formatStoryForSharing();

            // Try to copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(storyText).then(() => {
                    addMessage('üìã Story copied to clipboard! Share your bird\'s journey! üê¶', 'success');
                }).catch(err => {
                    // Fallback: show text in an alert for manual copying
                    prompt('üìã Copy this text to share your story:', storyText);
                });
            } else {
                // Fallback for browsers without clipboard API
                prompt('üìã Copy this text to share your story:', storyText);
            }
        }

        function formatStoryForSharing() {
            // Create a shareable text version of the bird's life story
            const stats = gameState;
            const seasonName = SEASONS[stats.season];

            let story = `üê¶ BIRD WINDOW RPG - My Life Story üê¶\n\n`;

            // Header with character info
            story += `üìä ${stats.species} - Level ${stats.level}\n`;
            story += `üóìÔ∏è  Year ${stats.year}, ${seasonName} (Turn ${stats.turn})\n`;
            story += `‚ù§Ô∏è  Health: ${stats.health}/${stats.maxHealth} | ‚ö° Energy: ${stats.energy}/${stats.maxEnergy}\n`;
            story += `üçñ Hunger: ${stats.hunger}/100 | üë• Social: ${stats.socialStanding}/100\n\n`;

            // Achievements
            story += `üèÜ ACHIEVEMENTS:\n`;
            story += `${stats.hasNest ? '‚úÖ' : '‚ùå'} Built a nest\n`;
            story += `${stats.hasBirdhouse ? '‚úÖ' : '‚ùå'} Built a birdhouse\n`;
            story += `${stats.hasMate ? '‚úÖ' : '‚ùå'} Found a mate\n`;
            if (stats.offspring > 0) {
                story += `‚úÖ Raised ${stats.offspring} offspring to independence\n`;
            }
            if (stats.babies.length > 0) {
                story += `üê£ Currently raising ${stats.babies.length} ${stats.babies.length === 1 ? 'baby' : 'babies'}\n`;
            }
            if (stats.flockMembers.length > 0) {
                story += `ü¶Ö Leading a flock of ${stats.flockMembers.length} birds\n`;
            }
            story += `üìú Completed ${stats.completedQuests.length} quests\n`;
            story += `üåç Survived ${stats.year} ${stats.year === 1 ? 'year' : 'years'}\n\n`;

            // Notable stats
            story += `üìà SKILLS:\n`;
            story += `üîç Foraging: ${stats.skills.foraging} | üèóÔ∏è Building: ${stats.skills.building}\n`;
            story += `ü¶Ö Flying: ${stats.skills.flying} | ‚öîÔ∏è Combat: ${stats.skills.combat}\n`;
            story += `üë• Flocking: ${stats.skills.flocking} | üëÅÔ∏è Perception: ${stats.skills.perception}\n\n`;

            // Recent diary entries (last 10)
            const recentEntries = stats.diary.slice(-10).reverse();
            if (recentEntries.length > 0) {
                story += `üìñ RECENT MEMORIES:\n\n`;
                recentEntries.forEach(entry => {
                    const icon = {
                        event: 'üìÖ',
                        milestone: '‚≠ê',
                        combat: '‚öîÔ∏è',
                        social: 'üí¨',
                        family: 'üë®‚Äçüë©‚Äçüëß',
                        achievement: 'üèÜ',
                        special: '‚ú®',
                        tragedy: 'üíî'
                    }[entry.type] || 'üìÖ';

                    story += `${icon} ${entry.season} Y${entry.year}, T${entry.turn}\n`;
                    story += `   ${entry.text}\n\n`;
                });
            }

            // Footer
            story += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            story += `üéÆ Play Bird Window RPG!\n`;
            story += `A bird life simulator where you nest, forage, raise young, and survive the seasons! üå∏‚òÄÔ∏èüçÇ‚ùÑÔ∏è\n`;

            return story;
        }

        // ===== WEATHER SYSTEM =====
        const WEATHER_TYPES = {
            clear: { icon: '‚òÄÔ∏è', name: 'Clear skies', color: '#e3f2fd', forageMod: 0, energyMod: 0 },
            rain: { icon: 'üåßÔ∏è', name: 'Rainy', color: '#cfd8dc', forageMod: -2, energyMod: -5 },
            storm: { icon: '‚õàÔ∏è', name: 'Stormy', color: '#90a4ae', forageMod: -5, energyMod: -10 },
            snow: { icon: '‚ùÑÔ∏è', name: 'Snowy', color: '#e1f5fe', forageMod: -3, energyMod: -8 },
            wind: { icon: 'üí®', name: 'Windy', color: '#b2ebf2', forageMod: -1, energyMod: -3 }
        };

        function updateWeather() {
            // Weather changes based on season
            const seasonWeather = {
                0: ['clear', 'clear', 'rain', 'wind'], // Spring
                1: ['clear', 'clear', 'clear', 'rain'], // Summer
                2: ['clear', 'rain', 'wind', 'wind'], // Fall
                3: ['snow', 'snow', 'wind', 'clear'] // Winter
            };

            const possibleWeather = seasonWeather[gameState.season];
            let newWeather = possibleWeather[Math.floor(Math.random() * possibleWeather.length)];

            // Chance of storm
            if (Math.random() < 0.1) {
                newWeather = gameState.season === 3 ? 'snow' : 'storm';
            }

            gameState.weather = newWeather;
            gameState.weatherIntensity = Math.random() * 0.5 + 0.5;

            // Update UI
            const weatherData = WEATHER_TYPES[gameState.weather];
            document.getElementById('weather-icon').textContent = weatherData.icon;
            document.getElementById('weather-text').textContent = weatherData.name;
            document.getElementById('weather-display').style.background = `linear-gradient(135deg, ${weatherData.color}, ${weatherData.color}cc)`;

            // Add diary entry for significant weather
            if (gameState.weather === 'storm') {
                addDiaryEntry('A fierce storm rolled in, making survival difficult.', 'event');
            } else if (gameState.weather === 'snow' && gameState.season === 3) {
                addDiaryEntry('Snow blanketed the landscape, signaling winter\'s harsh grip.', 'event');
            }
        }

        function getWeatherModifiers() {
            const weather = WEATHER_TYPES[gameState.weather] || WEATHER_TYPES.clear;
            return {
                forageDC: weather.forageMod,
                energyCost: weather.energyMod
            };
        }

        // ===== BIRD DRAWING =====
        function drawBird(ctx, x, y, size, color, animate = false) {
            // Simplified bird drawing based on simulation
            const sizeMultiplier = size / 20; // Base size of 20

            // Wing flap animation for animated bird
            const wingFlap = animate ? Date.now() / 200 : 0;
            const yOffset = animate ? Math.sin(Date.now() / 300) * 1.5 : 0;
            const wingAngle = animate ? Math.sin(wingFlap) * 0.6 : 0.2; // Angle for wing rotation

            ctx.save();

            // Draw tail
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x - 8 * sizeMultiplier, y + yOffset);
            ctx.lineTo(x - 13 * sizeMultiplier, y - 2 * sizeMultiplier + yOffset);
            ctx.lineTo(x - 13 * sizeMultiplier, y + 2 * sizeMultiplier + yOffset);
            ctx.closePath();
            ctx.fill();

            // Draw wings BEHIND body (drawn first so body covers part of them)
            ctx.fillStyle = shadeColor(color, -20); // Darker wings

            // Left wing - positioned more to the back/side
            ctx.beginPath();
            ctx.ellipse(
                x - 2 * sizeMultiplier, // Closer to center
                y + 1 * sizeMultiplier + yOffset, // Slightly lower
                7 * sizeMultiplier, // Smaller radius
                3 * sizeMultiplier, // Thinner
                -Math.PI / 3 - wingAngle * 0.5, // Angled back more
                0, Math.PI * 2
            );
            ctx.fill();

            // Right wing - positioned more to the back/side
            ctx.beginPath();
            ctx.ellipse(
                x + 2 * sizeMultiplier, // Closer to center
                y + 1 * sizeMultiplier + yOffset, // Slightly lower
                7 * sizeMultiplier, // Smaller radius
                3 * sizeMultiplier, // Thinner
                Math.PI / 3 + wingAngle * 0.5, // Angled back more (mirrored)
                0, Math.PI * 2
            );
            ctx.fill();

            // Draw body ON TOP of wings
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.ellipse(
                x, y + yOffset,
                8 * sizeMultiplier,
                6 * sizeMultiplier,
                0, 0, Math.PI * 2
            );
            ctx.fill();

            // Draw belly (lighter)
            ctx.fillStyle = shadeColor(color, 40);
            ctx.beginPath();
            ctx.ellipse(
                x, y + 2 * sizeMultiplier + yOffset,
                6 * sizeMultiplier,
                4 * sizeMultiplier,
                0, 0, Math.PI
            );
            ctx.fill();

            // Draw head
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x + 5 * sizeMultiplier, y - 3 * sizeMultiplier + yOffset, 4 * sizeMultiplier, 0, Math.PI * 2);
            ctx.fill();

            // Draw eye
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(x + 7 * sizeMultiplier, y - 3 * sizeMultiplier + yOffset, 1 * sizeMultiplier, 0, Math.PI * 2);
            ctx.fill();

            // Draw beak
            ctx.fillStyle = '#ff9800';
            ctx.beginPath();
            ctx.moveTo(x + 9 * sizeMultiplier, y - 3 * sizeMultiplier + yOffset);
            ctx.lineTo(x + 12 * sizeMultiplier, y - 2.5 * sizeMultiplier + yOffset);
            ctx.lineTo(x + 9 * sizeMultiplier, y - 2 * sizeMultiplier + yOffset);
            ctx.closePath();
            ctx.fill();

            ctx.restore();
        }

        // Helper function to lighten/darken colors
        function shadeColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, Math.max(0, (num >> 16) + amt));
            const G = Math.min(255, Math.max(0, (num >> 8 & 0x00FF) + amt));
            const B = Math.min(255, Math.max(0, (num & 0x0000FF) + amt));
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        // ===== CANVAS MAP SYSTEM =====
        function drawCanvasMap() {
            const canvas = document.getElementById('map-canvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const cellSize = canvas.width / 3; // Responsive cell size

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Simple light background
            ctx.fillStyle = '#f0f8ff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw territories (simplified emoji-based)
            for (let i = 0; i < 9; i++) {
                const row = Math.floor(i / 3);
                const col = i % 3;
                const x = col * cellSize;
                const y = row * cellSize;

                const territory = gameState.territories[i];
                const isCurrent = i === gameState.currentLocation;

                // Simple border for current location
                if (isCurrent) {
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(x + 2, y + 2, cellSize - 4, cellSize - 4);
                } else {
                    ctx.strokeStyle = '#ddd';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, cellSize, cellSize);
                }

                // Territory emoji (large and centered)
                ctx.font = `${cellSize * 0.4}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(territory.emoji, x + cellSize / 2, y + cellSize / 2 - cellSize * 0.15);

                // Territory name (smaller, below emoji)
                ctx.font = `bold ${cellSize * 0.08}px sans-serif`;
                ctx.fillStyle = '#333';
                ctx.fillText(territory.name, x + cellSize / 2, y + cellSize * 0.85);

                // NPCs (emoji-based instead of drawn)
                if (territory.npcs.length > 0) {
                    ctx.font = `${cellSize * 0.15}px serif`;
                    ctx.fillText('üê¶', x + cellSize * 0.2, y + cellSize * 0.2);
                }

                // Predators (emoji)
                if (territory.predators.length > 0) {
                    ctx.font = `${cellSize * 0.12}px serif`;
                    ctx.fillText('‚ö†Ô∏è', x + cellSize * 0.8, y + cellSize * 0.2);
                }

                // Player bird (drawn, animated)
                if (isCurrent) {
                    const playerColor = BIRD_SPECIES[gameState.species].color;
                    drawBird(ctx, x + cellSize / 2, y + cellSize / 2 + cellSize * 0.25, cellSize * 0.16, playerColor, true);

                    // Flock members (drawn, circling)
                    if (gameState.flockMembers && gameState.flockMembers.length > 0) {
                        const time = Date.now() / 1000;
                        gameState.flockMembers.forEach((member, index) => {
                            const angle = (time + index * (Math.PI * 2 / gameState.flockMembers.length)) % (Math.PI * 2);
                            const radius = cellSize * 0.25 + Math.sin(time * 2 + index) * cellSize * 0.03;
                            const flockX = x + cellSize / 2 + Math.cos(angle) * radius;
                            const flockY = y + cellSize / 2 + cellSize * 0.25 + Math.sin(angle) * radius * 0.6;

                            let flockColor = '#95a5a6';
                            if (member.species && BIRD_SPECIES[member.species]) {
                                flockColor = BIRD_SPECIES[member.species].color;
                            }

                            drawBird(ctx, flockX, flockY, cellSize * 0.11, flockColor, true);
                        });
                    }
                }
            }

            // Weather emoji overlay
            if (gameState.weather !== 'clear') {
                const weatherEmoji = WEATHER_TYPES[gameState.weather].icon;
                ctx.font = `${cellSize * 0.15}px serif`;
                ctx.textAlign = 'right';
                ctx.textBaseline = 'top';
                ctx.fillStyle = 'rgba(0,0,0,0.6)';
                ctx.fillText(`${weatherEmoji} ${WEATHER_TYPES[gameState.weather].name}`, canvas.width - 10, 10);
            }

            // Mushroom Mode emoji overlay
            if (gameState.mushroomModeActive) {
                const time = Date.now() / 1000;
                ctx.globalAlpha = 0.7 + Math.sin(time * 3) * 0.3;
                ctx.font = `bold ${cellSize * 0.15}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.fillStyle = '#ff00ff';
                ctx.fillText('üçÑ MUSHROOM MODE üçÑ', canvas.width / 2, cellSize * 0.1);
                ctx.globalAlpha = 1;
            }
        }

        // Animate canvas map
        function animateMap() {
            drawCanvasMap();
            requestAnimationFrame(animateMap);
        }

        // Handle canvas clicks for territory navigation
        function handleCanvasClick(event) {
            const canvas = document.getElementById('map-canvas');
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;

            const cellSize = canvas.width / 3;
            const col = Math.floor(x / cellSize);
            const row = Math.floor(y / cellSize);
            const clickedLocation = row * 3 + col;

            // Check if clicked territory is adjacent
            const currentLoc = gameState.currentLocation;
            const currentRow = Math.floor(currentLoc / 3);
            const currentCol = currentLoc % 3;
            const distance = Math.abs(currentRow - row) + Math.abs(currentCol - col);

            if (distance === 1 && clickedLocation >= 0 && clickedLocation < 9) {
                moveToTerritory(clickedLocation);
            }
        }

        // ===== MESSAGES =====
        function addMessage(text, type = 'info') {
            const log = document.getElementById('message-log');
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            log.appendChild(msg);
            log.scrollTop = log.scrollHeight;

            // Keep only last 20 messages
            while (log.children.length > 20) {
                log.removeChild(log.firstChild);
            }
        }

        // ===== GAME OVER =====
        function gameOver() {
            gameState.gameOver = true;

            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            const buttons = document.getElementById('modal-buttons');

            title.textContent = 'üíÄ Game Over';
            body.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 72px; margin-bottom: 20px;">ü™¶</div>
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">Your journey has ended...</div>
                    <div style="font-size: 14px; margin: 10px 0;">
                        <div>Survived: ${gameState.year} year(s), ${SEASONS[gameState.season]}</div>
                        <div>Level: ${gameState.level}</div>
                        <div>Offspring: ${gameState.offspring}</div>
                        <div>Quests Completed: ${gameState.completedQuests.length}</div>
                    </div>
                </div>
            `;

            buttons.innerHTML = '<button class="modal-btn primary" onclick="newGame()">New Game</button>';
            modal.classList.add('active');
        }

        // ===== TUTORIAL =====
        const TUTORIAL_STEPS = [
            {
                title: 'üê¶ Welcome to Bird Window RPG!',
                content: `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 72px; margin-bottom: 10px;">üê¶</div>
                        <p style="font-size: 18px; font-weight: bold; color: #667eea;">You are a young Bluebird</p>
                    </div>

                    <p style="margin-bottom: 15px; line-height: 1.6;">
                        Welcome to the wild! You've just left the nest and must now survive on your own.
                        The seasons will test you, but with wit and determination, you can thrive.
                    </p>

                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="font-size: 13px; margin: 0;">
                            ü™ü <strong>About This Window:</strong> This is a floating mini-game window!<br/>
                            You can drag it around, minimize it with the ‚àí button, and maximize it again by clicking the üê¶ bird icon or the launch button.
                        </p>
                    </div>

                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <p style="font-weight: bold; margin-bottom: 10px;">üéØ Your Goals:</p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>üè† Build a nest (10 twigs required)</li>
                            <li>üíï Find a mate through socializing</li>
                            <li>üåç Survive all 4 seasons</li>
                            <li>üê£ Raise offspring</li>
                            <li>‚≠ê Become a legendary bird</li>
                        </ul>
                    </div>
                `,
                button: 'Next'
            },
            {
                title: 'üìä Understanding Your Stats',
                content: `
                    <p style="margin-bottom: 15px;">Four vital stats determine your survival:</p>

                    <div style="display: grid; gap: 12px;">
                        <div style="background: #ffe6e6; padding: 12px; border-radius: 8px; border-left: 4px solid #ff6b6b;">
                            <div style="font-weight: bold; margin-bottom: 5px;">‚ù§Ô∏è Health (100 max)</div>
                            <div style="font-size: 13px;">Your life force. If it reaches 0, game over! Restore by completing seasons and leveling up.</div>
                        </div>

                        <div style="background: #fff4e6; padding: 12px; border-radius: 8px; border-left: 4px solid #f9ca24;">
                            <div style="font-weight: bold; margin-bottom: 5px;">üçñ Hunger (0-100)</div>
                            <div style="font-size: 13px;">Increases each turn. If it hits 100, you start losing health! Eat food to reduce it.</div>
                        </div>

                        <div style="background: #f0f0ff; padding: 12px; border-radius: 8px; border-left: 4px solid #6c5ce7;">
                            <div style="font-weight: bold; margin-bottom: 5px;">‚ö° Energy (100 max)</div>
                            <div style="font-size: 13px;">Used for actions. Rest to restore it. Running out of energy limits what you can do!</div>
                        </div>

                        <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; border-left: 4px solid #6c5ce7;">
                            <div style="font-weight: bold; margin-bottom: 5px;">‚≠ê Social Standing (0-100)</div>
                            <div style="font-size: 13px;">Your reputation. Higher standing helps you find mates and allies!</div>
                        </div>
                    </div>
                `,
                button: 'Next'
            },
            {
                title: 'üé≤ How Attempts Work',
                content: `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px;">üé≤</div>
                    </div>

                    <p style="margin-bottom: 15px;">When you try something challenging, the game tests your ability! You get a random number (1-20) and add your skill training.</p>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; font-family: monospace;">
                        <div style="text-align: center; font-size: 16px;">
                            <strong>Your Attempt + Skill Training ‚â• Challenge</strong>
                        </div>
                        <div style="text-align: center; font-size: 13px; margin-top: 5px; color: #666;">
                            Example: Attempt 14 + Foraging 2 = 16 (beats Challenge 10!)
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
                        <div style="background: #d4edda; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 5px;">üåü</div>
                            <div style="font-weight: bold; margin-bottom: 3px;">Perfect! (20)</div>
                            <div style="font-size: 12px;">Exceptional success!<br/>Amazing results!</div>
                        </div>

                        <div style="background: #f8d7da; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 5px;">üí•</div>
                            <div style="font-weight: bold; margin-bottom: 3px;">Fumble! (1)</div>
                            <div style="font-size: 12px;">Terrible luck!<br/>Things go wrong!</div>
                        </div>
                    </div>

                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <p style="font-size: 13px; margin: 0;">
                            üí° <strong>Tip:</strong> Level up to increase your skills and succeed more often!
                        </p>
                    </div>
                `,
                button: 'Next'
            },
            {
                title: 'üó∫Ô∏è Exploring the World',
                content: `
                    <p style="margin-bottom: 15px;">The world is divided into a <strong>3√ó3 grid of territories</strong>. Each location offers different resources and dangers.</p>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin: 20px 0; max-width: 300px; margin-left: auto; margin-right: auto;">
                        <div style="background: #e0f7fa; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; border: 2px solid #4dd0e1;">üå≤</div>
                        <div style="background: #e0f7fa; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; border: 2px solid #4dd0e1;">‚õ∞Ô∏è</div>
                        <div style="background: #e0f7fa; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; border: 2px solid #4dd0e1;">ü´ê</div>
                        <div style="background: #e0f7fa; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; border: 2px solid #4dd0e1;">üå≥</div>
                        <div style="background: #fff9e6; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; border: 3px solid #f39c12; font-weight: bold;">üê¶</div>
                        <div style="background: #e0f7fa; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; border: 2px solid #4dd0e1;">üíß</div>
                        <div style="background: #e0f7fa; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; border: 2px solid #4dd0e1;">üåª</div>
                        <div style="background: #e0f7fa; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; border: 2px solid #4dd0e1;">üå≥</div>
                        <div style="background: #e0f7fa; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; border: 2px solid #4dd0e1;">ü™®</div>
                    </div>

                    <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin: 15px 0;">
                        <p style="margin: 0; font-size: 13px; line-height: 1.6;">
                            üß≠ <strong>Your current location</strong> is highlighted in gold.<br/>
                            ‚úàÔ∏è <strong>Click adjacent territories</strong> to fly there (costs 15 energy).<br/>
                            üëÄ You can see NPCs üê¶ and dangers ‚ö†Ô∏è in other territories.
                        </p>
                    </div>
                `,
                button: 'Next'
            },
            {
                title: 'üé¨ Key Actions',
                content: `
                    <p style="margin-bottom: 15px;">Here are the essential actions you'll use:</p>

                    <div style="display: grid; gap: 10px;">
                        <div style="background: #e8f5e9; padding: 10px; border-radius: 8px; border-left: 4px solid #4caf50;">
                            <div style="font-weight: bold; margin-bottom: 3px;">üîç Forage</div>
                            <div style="font-size: 12px;">Search for food (seeds, berries, worms). Essential for survival!</div>
                        </div>

                        <div style="background: #e8f5e9; padding: 10px; border-radius: 8px; border-left: 4px solid #4caf50;">
                            <div style="font-weight: bold; margin-bottom: 3px;">üåø Gather</div>
                            <div style="font-size: 12px;">Collect twigs for nest building. You need 10 total!</div>
                        </div>

                        <div style="background: #fff3e0; padding: 10px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <div style="font-weight: bold; margin-bottom: 3px;">üèóÔ∏è Build Nest</div>
                            <div style="font-size: 12px;">Use twigs to build your home. A completed nest is crucial!</div>
                        </div>

                        <div style="background: #f3e5f5; padding: 10px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                            <div style="font-weight: bold; margin-bottom: 3px;">üë• Socialize</div>
                            <div style="font-size: 12px;">Chat with other birds. Increases standing and may lead to finding a mate!</div>
                        </div>

                        <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <div style="font-weight: bold; margin-bottom: 3px;">üò¥ Rest</div>
                            <div style="font-size: 12px;">Restore energy. Rest at night for bonus recovery!</div>
                        </div>

                        <div style="background: #ffe0b2; padding: 10px; border-radius: 8px; border-left: 4px solid #ff6f00;">
                            <div style="font-weight: bold; margin-bottom: 3px;">üçñ Eat</div>
                            <div style="font-size: 12px;">Consume food to reduce hunger. Don't let hunger reach 100!</div>
                        </div>
                    </div>
                `,
                button: 'Next'
            },
            {
                title: 'üå∏ Seasons & Time',
                content: `
                    <p style="margin-bottom: 15px;">Time passes through <strong>four seasons</strong>, each lasting <strong>10 turns</strong>:</p>

                    <div style="display: grid; gap: 10px; margin: 15px 0;">
                        <div style="background: linear-gradient(135deg, #ffeef8, #ffe6f0); padding: 12px; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">üå∏ Spring</div>
                            <div style="font-size: 13px;">Time to build your nest and find a mate!</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #fff8e1, #ffecb3); padding: 12px; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">‚òÄÔ∏è Summer</div>
                            <div style="font-size: 13px;">Raise babies, defend your nest from predators.</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 12px; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">üçÇ Fall</div>
                            <div style="font-size: 13px;">Prepare for winter! Gather resources.</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #e1f5fe, #b3e5fc); padding: 12px; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">‚ùÑÔ∏è Winter</div>
                            <div style="font-size: 13px;">Survive! Food is scarce, energy drains faster.</div>
                        </div>
                    </div>

                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <p style="font-size: 13px; margin: 0;">
                            ‚è∞ Each turn alternates between ‚òÄÔ∏è <strong>Day</strong> and üåô <strong>Night</strong><br/>
                            üéØ Complete seasonal quests for bonus XP!
                        </p>
                    </div>
                `,
                button: 'Next'
            },
            {
                title: '‚öîÔ∏è Combat & Dangers',
                content: `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 48px;">üêÄ üêøÔ∏è ü¶â</div>
                    </div>

                    <p style="margin-bottom: 15px;">The wild is dangerous! You may encounter <strong>predators</strong> that want to eat you or raid your nest:</p>

                    <div style="display: grid; gap: 10px; margin: 15px 0;">
                        <div style="background: #ffebee; padding: 10px; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">üêÄ Rat (HP: 30)</div>
                            <div style="font-size: 12px;">Common threat. Steals eggs and food.</div>
                        </div>

                        <div style="background: #ffebee; padding: 10px; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">üêøÔ∏è Squirrel (HP: 40)</div>
                            <div style="font-size: 12px;">Opportunistic. Raids nests for materials.</div>
                        </div>

                        <div style="background: #ffebee; padding: 10px; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">ü¶â Owl (HP: 60)</div>
                            <div style="font-size: 12px;">Deadly night hunter. Very dangerous!</div>
                        </div>
                    </div>

                    <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <p style="font-weight: bold; margin-bottom: 8px;">Combat Options:</p>
                        <ul style="margin-left: 20px; font-size: 13px; line-height: 1.6;">
                            <li>‚öîÔ∏è <strong>Attack:</strong> Deal damage (requires Combat check)</li>
                            <li>üõ°Ô∏è <strong>Defend:</strong> Reduce incoming damage</li>
                            <li>üèÉ <strong>Flee:</strong> Escape combat (requires Flying check)</li>
                        </ul>
                    </div>
                `,
                button: 'Next'
            },
            {
                title: '‚≠ê Skills & Training',
                content: `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 48px;">‚≠ê</div>
                    </div>

                    <p style="margin-bottom: 15px;">As you gain experience and level up, you can <strong>train your skills</strong>! Each skill level makes you better at specific actions:</p>

                    <div style="display: grid; gap: 8px; margin: 15px 0;">
                        <div style="background: #e8f5e9; padding: 10px; border-radius: 8px; border-left: 3px solid #4caf50;">
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 3px;">üîç Foraging</div>
                            <div style="font-size: 12px;">Find food more easily (easier to beat the challenge number!)</div>
                        </div>

                        <div style="background: #fff3e0; padding: 10px; border-radius: 8px; border-left: 3px solid #ff9800;">
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 3px;">üèóÔ∏è Building</div>
                            <div style="font-size: 12px;">Construct nests faster and with better materials</div>
                        </div>

                        <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; border-left: 3px solid #2196f3;">
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 3px;">‚úàÔ∏è Flying</div>
                            <div style="font-size: 12px;">Escape predators and migrate more successfully</div>
                        </div>

                        <div style="background: #ffebee; padding: 10px; border-radius: 8px; border-left: 3px solid #f44336;">
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 3px;">‚öîÔ∏è Combat</div>
                            <div style="font-size: 12px;">Fight off rats, owls, and other predators</div>
                        </div>

                        <div style="background: #f3e5f5; padding: 10px; border-radius: 8px; border-left: 3px solid #9c27b0;">
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 3px;">üë• Flocking</div>
                            <div style="font-size: 12px;">Lead other birds and find mates more easily</div>
                        </div>

                        <div style="background: #fce4ec; padding: 10px; border-radius: 8px; border-left: 3px solid #ec407a;">
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 3px;">üëÅÔ∏è Perception</div>
                            <div style="font-size: 12px;">Spot predators early and find hidden treasures</div>
                        </div>
                    </div>

                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <p style="font-size: 13px; margin: 0;">
                            üåü <strong>Each time you level up</strong>, you choose ONE skill to increase by +1!<br/>
                            üí™ Higher skills = higher numbers on attempts = more success!
                        </p>
                    </div>
                `,
                button: 'Next'
            },
            {
                title: 'üöÄ Ready to Begin!',
                content: `
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 64px; margin-bottom: 15px;">üê¶‚ú®</div>
                        <p style="font-size: 18px; font-weight: bold; color: #667eea; margin-bottom: 10px;">
                            Your adventure awaits!
                        </p>
                    </div>

                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <p style="font-weight: bold; margin-bottom: 10px;">üìã Quick Start Tips:</p>
                        <ol style="margin-left: 20px; font-size: 13px; line-height: 1.8;">
                            <li>Start by <strong>foraging</strong> and <strong>gathering</strong> to build up resources</li>
                            <li>Build your <strong>nest</strong> as soon as you have 10 twigs</li>
                            <li>Keep hunger below 100 by eating regularly</li>
                            <li>Socialize with other birds to find a mate</li>
                            <li>Rest when energy is low (especially at night!)</li>
                            <li>Watch the dice rolls and learn the patterns</li>
                        </ol>
                    </div>

                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; text-align: center; margin: 15px 0;">
                        <p style="margin: 0; font-size: 14px;">
                            üíæ <strong>Game auto-saves after every action!</strong><br/>
                            <span style="font-size: 12px;">You can close the browser and return anytime.</span>
                        </p>
                    </div>

                    <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 13px;">
                            ü™ü <strong>After choosing your bird, the window will minimize.</strong><br/>
                            <span style="font-size: 12px;">Click the üê¶ bird icon or "Bird RPG" button to open it again and start playing!</span>
                        </p>
                    </div>

                    <div style="text-align: center; margin-top: 20px; font-size: 24px;">
                        üå∏ Good luck, young bird! üå∏
                    </div>
                `,
                button: 'Choose Your Bird! üê¶'
            }
        ];

        function skipTutorial() {
            showSpeciesSelection();
        }

        function showTutorial(step = 0) {
            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            const buttons = document.getElementById('modal-buttons');

            if (step >= TUTORIAL_STEPS.length) {
                showSpeciesSelection();
                return;
            }

            const tutorialData = TUTORIAL_STEPS[step];
            title.textContent = tutorialData.title;
            body.innerHTML = tutorialData.content + `
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <button class="modal-btn secondary" onclick="skipTutorial()" style="font-size: 11px; padding: 6px 12px;">
                        ‚è≠Ô∏è Skip Tutorial (Press ESC)
                    </button>
                </div>
            `;

            buttons.innerHTML = `
                ${step > 0 ? '<button class="modal-btn secondary" onclick="showTutorial(' + (step - 1) + ')">Back</button>' : ''}
                <button class="modal-btn primary" onclick="showTutorial(${step + 1})">${tutorialData.button}</button>
            `;

            modal.classList.add('active');

            // Add ESC key listener (remove previous listeners first)
            document.onkeydown = function(e) {
                if (e.key === 'Escape') {
                    skipTutorial();
                }
            };
        }

        function showSpeciesSelection() {
            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            const buttons = document.getElementById('modal-buttons');

            title.textContent = 'üê¶ Choose Your Bird Species';

            let speciesHTML = '<div style="margin-bottom: 15px; text-align: center; color: #666;">Each species has unique strengths and weaknesses!</div><div style="display: grid; gap: 12px;">';

            for (const [key, species] of Object.entries(BIRD_SPECIES)) {
                speciesHTML += `
                    <div style="background: linear-gradient(135deg, ${species.color}22, ${species.color}11);
                                border: 2px solid ${species.color};
                                border-radius: 10px;
                                padding: 15px;
                                cursor: pointer;
                                transition: all 0.2s;"
                         onmouseover="this.style.transform='scale(1.02)'"
                         onmouseout="this.style.transform='scale(1)'"
                         onclick="selectSpecies('${key}')">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 48px;">${species.emoji}</div>
                            <div style="flex: 1;">
                                <div style="font-size: 18px; font-weight: bold; color: ${species.color}; margin-bottom: 5px;">
                                    ${species.name}
                                </div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                                    ${species.description}
                                </div>
                                <div style="font-size: 11px; color: #888;">
                                    Skills: Foraging ${species.startingSkills.foraging}, Building ${species.startingSkills.building},
                                    Flying ${species.startingSkills.flying}, Combat ${species.startingSkills.combat},
                                    Flocking ${species.startingSkills.flocking}, Perception ${species.startingSkills.perception}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            speciesHTML += '</div>';

            body.innerHTML = speciesHTML;
            buttons.innerHTML = '';
            modal.classList.add('active');
        }

        function selectSpecies(speciesKey) {
            const species = BIRD_SPECIES[speciesKey];
            gameState.species = species.name;

            // Apply species bonuses
            gameState.skills = { ...species.startingSkills };
            gameState.maxHealth = 100 + species.bonuses.health;
            gameState.health = gameState.maxHealth;
            gameState.maxEnergy = 100 + species.bonuses.energy;
            gameState.energy = gameState.maxEnergy;
            gameState.socialStanding = 50 + species.bonuses.socialStanding;

            startGame();
        }

        function startGame() {
            gameState.hasSeenIntro = true;
            gameState.tutorialActive = true;
            closeModal();
            addMessage(`üå∏ Spring has arrived! Your journey begins in Oak Meadow as a ${gameState.species}...`, 'success');
            addMessage('üí° Tip: Start by foraging for food or gathering twigs!', 'info');
            addSeasonalQuest();
            updateUI();

            // Minimize the window after tutorial to encourage user interaction
            setTimeout(() => {
                const floatWindow = document.getElementById('bird-rpg-float');
                if (floatWindow) {
                    floatWindow.classList.add('minimized');
                }
            }, 1000); // Wait 1 second so they can see the game loaded
        }

        // ===== INIT =====
        // Create starfield for night mode
        function createStars() {
            const starsContainer = document.getElementById('stars-container');
            if (!starsContainer) return;

            // Create 100 stars with random positions
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                // Vary star sizes slightly
                const size = Math.random() * 2 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                starsContainer.appendChild(star);
            }
        }

        function init() {
            // Try to load save
            const loaded = loadGame();

            if (!loaded) {
                // New game
                initTerritories();
                saveGame();
            }

            // Initialize weather and canvas map
            updateWeather();
            animateMap();

            // Create stars for night mode
            createStars();

            // Add canvas click handler for territory navigation
            const canvas = document.getElementById('map-canvas');
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('touchend', handleCanvasClick);

            updateUI();

            if (!gameState.hasSeenIntro) {
                showTutorial(0);
            } else {
                addMessage('Game loaded. Welcome back!', 'info');
            }
        }

        // Start game on load
        window.onload = init;
    </script>

</body>
</html>
